<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TANGOYAï¼ˆå˜èªå±‹ï¼‰</title>

  <!-- Google Fonts (CDN) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Noto+Sans+KR:wght@400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />

  <!-- Kuromoji.js (CDN) â€” asyncë¡œ HTML íŒŒì‹± ë¸”ë¡œí‚¹ ì—†ì´ ë³‘ë ¬ ë‹¤ìš´ë¡œë“œ -->
  <!-- Kuromoji.js (ë¡œì»¬ â€” GitHub Pages ì„œë¹™) -->
  <script async src="kuromoji.js"></script>

  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CSS ë³€ìˆ˜
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root {
      --bg:       #0f0f13;
      --surface:  #18181f;
      --surface2: #222230;
      --border:   #2e2e40;
      --text:     #e8e8f0;
      --muted:    #7070a0;

      --N1: #ff4d6d;
      --N2: #ff8800;
      --N3: #ffd600;
      --N4: #00e676;
      --N5: #40c4ff;
      --EX: #6060a0;

      --radius-sm: 6px;
      --radius-md: 12px;
      --radius-lg: 18px;
    }

    /* â”€â”€ ë¼ì´íŠ¸ ëª¨ë“œ â”€â”€ */
    body.light-mode {
      --bg:       #f4f4f8;
      --surface:  #ffffff;
      --surface2: #eaeaf2;
      --border:   #d0d0e0;
      --text:     #1a1a2e;
      --muted:    #7070a0;

      --N1: #d62b4b;
      --N2: #c86000;
      --N3: #9a8200;
      --N4: #00a050;
      --N5: #0090cc;
      --EX: #5050a0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë¦¬ì…‹ & ê¸°ë³¸
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Noto Sans KR', sans-serif;
      font-weight: 400;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 48px 24px 80px;
      line-height: 1.6;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë ˆì´ì•„ì›ƒ ë˜í¼
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .container {
      width: 100%;
      max-width: 860px;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘  í—¤ë” ì˜ì—­
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      text-align: center;
      padding-top: 12px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px 14px;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 0.12em;
      color: var(--muted);
      text-transform: uppercase;
    }

    .badge-dot {
      display: inline-block;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--N5);
      animation: pulse 2.4s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.35; }
    }

    .header-title {
      font-family: 'Noto Serif JP', serif;
      font-weight: 700;
      font-size: clamp(32px, 6vw, 52px);
      letter-spacing: 0.04em;
      color: var(--text);
      line-height: 1.2;
    }

    .header-subtitle {
      font-size: 14px;
      color: var(--muted);
      font-weight: 300;
      max-width: 480px;
      line-height: 1.75;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘¡ ë ˆë²¨ ë²”ë¡€
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px 20px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 12px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
    }

    .legend-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .legend-item .lv-label {
      font-weight: 500;
      color: var(--text);
      letter-spacing: 0.04em;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘¢ ì…ë ¥ ì¹´ë“œ
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 28px 32px;
    }

    .card-label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 12px;
      font-family: 'DM Mono', monospace;
    }

    .input-row {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .input-btn-col {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
    }

    textarea#inputText {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text);
      font-family: 'Noto Serif JP', serif;
      font-size: 16px;
      line-height: 1.7;
      padding: 14px 16px;
      resize: vertical;
      min-height: 100px;
      outline: none;
      transition: border-color 0.2s;
    }

    textarea#inputText::placeholder {
      color: var(--muted);
      font-size: 14px;
    }

    textarea#inputText:focus {
      border-color: var(--N5);
    }

    /* â”€â”€ ë¶„ì„í•˜ê¸° ë²„íŠ¼ â”€â”€ */
    #analyzeBtn {
      flex-shrink: 0;
      background: linear-gradient(135deg, #4fa3e0 0%, #6c8ef5 100%);
      color: #fff;
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 13px;
      font-weight: 700;
      padding: 0 22px;
      height: 52px;
      cursor: pointer;
      letter-spacing: 0.06em;
      transition: opacity 0.18s, transform 0.12s, box-shadow 0.18s;
      white-space: nowrap;
      box-shadow: 0 2px 12px rgba(79, 163, 224, 0.28);
      position: relative;
      overflow: hidden;
    }

    #analyzeBtn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0);
      transition: background 0.15s;
    }

    #analyzeBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(79, 163, 224, 0.42);
    }

    #analyzeBtn:hover::after {
      background: rgba(255,255,255,0.08);
    }

    #analyzeBtn:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(79, 163, 224, 0.22);
    }

    #analyzeBtn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* â”€â”€ ì´ˆê¸°í™” ë²„íŠ¼ â”€â”€ */
    #resetBtn {
      flex-shrink: 0;
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 12px;
      font-weight: 500;
      padding: 0 16px;
      height: 52px;
      cursor: pointer;
      letter-spacing: 0.04em;
      transition: color 0.18s, border-color 0.18s, background 0.18s, transform 0.12s;
      white-space: nowrap;
    }

    #resetBtn:hover {
      color: var(--text);
      border-color: rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.05);
      transform: translateY(-1px);
    }

    #resetBtn:active {
      transform: translateY(0);
    }

    .btn-analyze {
      /* ë ˆê±°ì‹œ ì°¸ì¡°ìš© â€” ì‹¤ì œ ìŠ¤íƒ€ì¼ì€ #analyzeBtn */
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘£ ì—ëŸ¬ ë©”ì‹œì§€
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #errorMsg {
      background: rgba(255, 77, 109, 0.1);
      border: 1px solid rgba(255, 77, 109, 0.35);
      border-radius: var(--radius-md);
      color: var(--N1);
      font-size: 13px;
      padding: 12px 18px;
      display: none;
    }

    #errorMsg.visible {
      display: block;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘¤ ë¡œë”©
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #loading {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 40px 0;
      color: var(--muted);
      font-size: 13px;
      letter-spacing: 0.06em;
    }

    #loading.visible {
      display: flex;
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--N5);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘¥ ê²°ê³¼ ì˜ì—­
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #resultArea {
      display: none;
      flex-direction: column;
      gap: 20px;
    }

    #resultArea.visible {
      display: flex;
    }

    /* ê²°ê³¼ ë‚´ìš© ì»¨í…Œì´ë„ˆ */
    #resultContent {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 28px 32px;
      min-height: 80px;
    }

    /* â”€â”€ ë‹¨ì¼ ë‹¨ì–´ ê²°ê³¼ ì¹´ë“œ â”€â”€ */
    .single-word-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 24px 0;
      text-align: center;
    }

    .single-word-card .word-jp {
      font-family: 'Noto Serif JP', serif;
      font-size: clamp(36px, 8vw, 64px);
      font-weight: 700;
      line-height: 1.1;
    }

    .single-word-card .word-reading {
      font-family: 'DM Mono', monospace;
      font-size: 18px;
      color: var(--muted);
    }

    .single-word-card .word-kr {
      font-size: 22px;
      font-weight: 500;
      color: var(--text);
    }

    .single-word-card .word-level-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 5px 16px;
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.08em;
    }

    /* â”€â”€ í† í° ìŠ¤íŠ¸ë¦¼ (ì—¬ëŸ¬ ë‹¨ì–´) â”€â”€ */
    .token-stream {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-start;
    }

    .token-card {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      border-radius: var(--radius-sm);
      padding: 8px 12px;
      border: 1px solid transparent;
      cursor: default;
      transition: transform 0.12s;
      min-width: 48px;
    }

    .token-card:hover {
      transform: translateY(-2px);
    }

    /* ë³‘í•© ë²„íŠ¼ */
    .btn-merge {
      position: absolute;
      top: -7px;
      right: -7px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.15s, background 0.15s, color 0.15s, transform 0.12s;
      padding: 0;
      z-index: 2;
    }

    .token-card:hover .btn-merge {
      opacity: 1;
    }

    .btn-merge:hover {
      background: #4fa3e0;
      border-color: #4fa3e0;
      color: #fff;
      transform: scale(1.15);
    }

    /* ë³‘í•©ëœ ì¹´ë“œ í‘œì‹œ */
    .token-card.merged {
      outline: 1px dashed rgba(79,163,224,0.5);
      outline-offset: 1px;
    }

    /* ë³‘í•© ì·¨ì†Œ ë²„íŠ¼ */
    .btn-unmerge {
      position: absolute;
      top: -7px;
      right: -7px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(79,163,224,0.25);
      border: 1px solid #4fa3e0;
      color: #4fa3e0;
      font-size: 10px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.15s, background 0.15s, color 0.15s, transform 0.12s;
      padding: 0;
      z-index: 2;
    }

    .token-card:hover .btn-unmerge {
      opacity: 1;
    }

    .btn-unmerge:hover {
      background: #ff6b6b;
      border-color: #ff6b6b;
      color: #fff;
      transform: scale(1.15);
    }

    .token-jp {
      font-family: 'Noto Serif JP', serif;
      font-size: 17px;
      font-weight: 700;
      line-height: 1.2;
    }

    .token-reading {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      opacity: 0.7;
    }

    .token-lv {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      letter-spacing: 0.06em;
      opacity: 0.8;
    }

    .token-pos {
      font-size: 9px;
      opacity: 0.65;
    }

    .token-kr {
      font-size: 10px;
      font-weight: 600;
      opacity: 1;
      cursor: default;
      border-radius: 3px;
      padding: 1px 3px;
      transition: background 0.15s;
    }

    body.admin-mode .token-kr {
      cursor: pointer;
      outline: 1.5px solid rgba(255,180,0,0.45);
      border-radius: 3px;
    }

    body.admin-mode .token-kr:hover {
      background: rgba(255,180,0,0.07);
      outline: 1.5px solid rgba(255,180,0,0.8);
    }

    .token-kr.edited {
      color: #7ee7b4;
    }

    .token-kr.edited::after {
      content: 'âœ';
      font-size: 8px;
      opacity: 0.7;
      margin-left: 2px;
      vertical-align: super;
    }

    /* ëœ» ì¶”ê°€ ë²„íŠ¼ (ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) */
    .btn-add-kr,
    .btn-add-word-kr {
      display: none;
    }

    body.admin-mode .btn-add-kr,
    body.admin-mode .btn-add-word-kr {
      display: inline-block;
    }

    /* ëœ» ì¶”ê°€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-add-kr {
      font-size: 9px;
      color: rgba(255,180,0,0.7);
      background: none;
      border: 1px dashed rgba(255,180,0,0.45);
      border-radius: 3px;
      padding: 1px 5px;
      cursor: pointer;
      line-height: 1.4;
      transition: all 0.15s;
    }

    .btn-add-kr:hover {
      color: #ffb400;
      border-color: rgba(255,180,0,0.8);
      background: rgba(255,180,0,0.07);
    }

    /* ì¸ë¼ì¸ í¸ì§‘ input */
    .kr-edit-input {
      font-size: 10px;
      font-weight: 600;
      font-family: 'Noto Sans KR', sans-serif;
      background: rgba(255,180,0,0.07);
      color: var(--text);
      border: 1.5px solid rgba(255,180,0,0.55);
      border-radius: 3px;
      padding: 1px 4px;
      width: 64px;
      outline: none;
      box-sizing: border-box;
    }

    .kr-edit-input:focus {
      border-color: #ffb400;
      box-shadow: 0 0 0 2px rgba(255,180,0,0.2);
    }

    /* ë‹¨ì–´ ì¹´ë“œ í•œêµ­ì–´ ëœ» í¸ì§‘ */
    .word-kr {
      cursor: default;
      border-radius: 4px;
      padding: 2px 6px;
      transition: background 0.15s;
    }

    body.admin-mode .word-kr {
      cursor: pointer;
      outline: 1.5px solid rgba(255,180,0,0.45);
      border-radius: 4px;
    }

    body.admin-mode .word-kr:hover {
      background: rgba(255,180,0,0.07);
      outline: 1.5px solid rgba(255,180,0,0.8);
    }

    .word-kr.edited {
      color: #7ee7b4;
    }

    .word-kr.edited::after {
      content: ' âœ';
      font-size: 11px;
      opacity: 0.7;
    }

    .word-kr-edit-input {
      font-size: 18px;
      font-family: 'Noto Sans KR', sans-serif;
      background: rgba(255,180,0,0.07);
      color: var(--text);
      border: 1.5px solid rgba(255,180,0,0.55);
      border-radius: 4px;
      padding: 4px 10px;
      width: 180px;
      outline: none;
      text-align: center;
      box-sizing: border-box;
      margin-top: 4px;
    }

    .word-kr-edit-input:focus {
      border-color: #ffb400;
      box-shadow: 0 0 0 2.5px rgba(255,180,0,0.2);
    }

    /* ë‹¨ì–´ ì¹´ë“œ ëœ» ì¶”ê°€ ë²„íŠ¼ */
    .btn-add-word-kr {
      font-size: 13px;
      color: rgba(255,180,0,0.7);
      background: none;
      border: 1px dashed rgba(255,180,0,0.45);
      border-radius: 4px;
      padding: 4px 14px;
      cursor: pointer;
      transition: all 0.15s;
      margin-top: 4px;
    }

    .btn-add-word-kr:hover {
      color: #ffb400;
      border-color: rgba(255,180,0,0.8);
      background: rgba(255,180,0,0.07);
    }

    /* ìˆ˜ì •ë‚´ì—­ ì´ˆê¸°í™” ë²„íŠ¼ */
    .btn-reset-edits {
      background: none;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 6px;
      color: var(--muted);
      font-size: 11px;
      padding: 5px 12px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-reset-edits:hover {
      color: #ff6b6b;
      border-color: #ff6b6b66;
    }

    /* â”€â”€ ë ˆë²¨ë³„ í† í° ìƒ‰ìƒ â”€â”€ */
    .lv-N1 {
      background: rgba(255, 77,  109, 0.12);
      border-color: rgba(255, 77,  109, 0.35);
      color: var(--N1);
    }
    .lv-N2 {
      background: rgba(255, 136,   0, 0.12);
      border-color: rgba(255, 136,   0, 0.35);
      color: var(--N2);
    }
    .lv-N3 {
      background: rgba(255, 214,   0, 0.12);
      border-color: rgba(255, 214,   0, 0.35);
      color: var(--N3);
    }
    .lv-N4 {
      background: rgba(  0, 230, 118, 0.12);
      border-color: rgba(  0, 230, 118, 0.35);
      color: var(--N4);
    }
    .lv-N5 {
      background: rgba( 64, 196, 255, 0.12);
      border-color: rgba( 64, 196, 255, 0.35);
      color: var(--N5);
    }
    .lv-EX {
      background: rgba( 96,  96, 160, 0.10);
      border-color: rgba( 96,  96, 160, 0.30);
      color: var(--EX);
    }

    /* â”€â”€ í†µê³„ ë°” â”€â”€ */
    .stats-bar {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 20px 0 0;
      border-top: 1px solid var(--border);
      margin-top: 20px;
    }

    .stats-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
    }

    .stats-lv-label {
      font-family: 'DM Mono', monospace;
      width: 28px;
      font-size: 11px;
      letter-spacing: 0.06em;
    }

    .stats-track {
      flex: 1;
      height: 6px;
      background: var(--surface2);
      border-radius: 999px;
      overflow: hidden;
    }

    .stats-fill {
      height: 100%;
      border-radius: 999px;
      transition: width 0.6s cubic-bezier(.25,.8,.25,1);
    }

    .stats-count {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      width: 32px;
      text-align: right;
    }

    /* íˆ´ë°” ì‚¬ì „ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) */
    #dictDownloadBtn {
      display: none;
      font-size: 12px;
      width: auto;
      padding: 0 10px;
      gap: 4px;
      white-space: nowrap;
      background: rgba(255,180,0,0.10);
      border-color: rgba(255,180,0,0.50);
      color: #ffb400;
    }

    body.admin-mode #dictDownloadBtn {
      display: flex;
    }

    #dictDownloadBtn:hover {
      background: rgba(255,180,0,0.20) !important;
      border-color: #ffb400 !important;
      color: #ffb400 !important;
    }

    /* â”€â”€ ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ â”€â”€ */
    .download-section {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .download-label {
      font-size: 11px;
      font-family: 'DM Mono', monospace;
      color: var(--muted);
      letter-spacing: 0.08em;
      margin-right: 4px;
    }

    .btn-download {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 12px;
      padding: 7px 16px;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
      letter-spacing: 0.04em;
    }

    .btn-download:hover {
      background: var(--border);
      border-color: var(--muted);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì•± í‘¸í„°
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .app-footer {
      margin-top: 48px;
      padding: 24px 0 12px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 6px 28px;
      justify-content: center;
      align-items: center;
    }

    .app-footer-item {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.04em;
      white-space: nowrap;
    }

    .app-footer-item strong {
      color: var(--text);
      font-weight: 600;
    }

    .app-footer-sep {
      color: var(--border);
      font-size: 13px;
      line-height: 1;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë°˜ì‘í˜• (480px ì´í•˜)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (max-width: 480px) {
      body {
        padding: 32px 16px 60px;
      }

      .card {
        padding: 20px 18px;
      }

      .input-row {
        flex-direction: column;
        align-items: stretch;
      }

      .input-btn-col {
        flex-direction: row;
      }

      #analyzeBtn {
        flex: 1;
        height: 48px;
        padding: 0;
      }

      #resetBtn {
        flex: 0 0 80px;
        height: 48px;
        padding: 0;
      }

      .legend {
        gap: 8px 14px;
      }

      #resultContent {
        padding: 20px 18px;
      }

      .download-section {
        flex-direction: column;
        align-items: flex-start;
      }

      .btn-download {
        width: 100%;
        text-align: center;
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       í•œêµ­ì–´ ì…ë ¥ ê²½ê³  ëª¨ë‹¬
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #langModal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    #langModal.visible {
      display: flex;
    }

    .lang-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.18s ease;
    }

    .lang-modal-box {
      position: relative;
      background: #1e1e2a;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 36px 32px 28px;
      max-width: 340px;
      width: 90%;
      text-align: center;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.55);
      animation: slideUp 0.22s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px) scale(0.96); }
      to   { opacity: 1; transform: translateY(0)   scale(1); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    .lang-modal-icon {
      font-size: 42px;
      margin-bottom: 14px;
      line-height: 1;
    }

    .lang-modal-title {
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }

    .lang-modal-desc {
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.65;
      margin-bottom: 24px;
    }

    .lang-modal-btn {
      background: linear-gradient(135deg, #4fa3e0 0%, #6c8ef5 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 14px;
      font-weight: 700;
      padding: 11px 36px;
      cursor: pointer;
      letter-spacing: 0.04em;
      box-shadow: 0 4px 14px rgba(79, 163, 224, 0.35);
      transition: opacity 0.15s, transform 0.12s;
    }

    .lang-modal-btn:hover {
      opacity: 0.88;
      transform: translateY(-1px);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       íˆ´ë°” (ìš°ìƒë‹¨ ê³ ì •)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #toolbar {
      position: fixed;
      top: 16px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
    }

    .tb-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--muted);
      font-size: 14px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.15s, color 0.15s, border-color 0.15s, transform 0.12s;
      padding: 0;
      line-height: 1;
    }

    .tb-btn:hover {
      background: var(--surface);
      color: var(--text);
      border-color: rgba(128,128,192,0.5);
      transform: translateY(-1px);
    }

    /* ê´€ë¦¬ì ëª¨ë“œ í™œì„± ì‹œ ë²„íŠ¼ ê°•ì¡° */
    .tb-btn.admin-active {
      background: rgba(255,180,0,0.15);
      border-color: rgba(255,180,0,0.6);
      color: #ffb400;
    }

    /* ê´€ë¦¬ì ëª¨ë“œ ë°°ì§€ (í—¤ë” í•˜ë‹¨) */
    #adminBadge {
      display: none;
      align-items: center;
      gap: 6px;
      background: rgba(255,180,0,0.12);
      border: 1px solid rgba(255,180,0,0.4);
      border-radius: 999px;
      padding: 4px 14px;
      font-size: 11px;
      font-family: 'DM Mono', monospace;
      letter-spacing: 0.1em;
      color: #ffb400;
      margin-top: 4px;
    }

    body.admin-mode #adminBadge {
      display: inline-flex;
    }

    .admin-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #ffb400;
      animation: pulse 1.5s ease-in-out infinite;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ê´€ë¦¬ì í¸ì§‘ìš© ì¸ë¼ì¸ select / input
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* â”€â”€ ê´€ë¦¬ì í¸ì§‘ í•„ë“œ ê³µí†µ (ë…¸ë€ í…Œë‘ë¦¬) â”€â”€ */
    .admin-input,
    .admin-select {
      background: rgba(255,180,0,0.07);
      border: 1.5px solid rgba(255,180,0,0.55);
      border-radius: 5px;
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      padding: 2px 5px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
      pointer-events: auto;
      position: relative;
      z-index: 3;
      box-sizing: border-box;
    }

    .admin-input {
      cursor: text;
      max-width: 72px;
    }

    .admin-select {
      cursor: pointer;
    }

    .admin-input:hover,
    .admin-select:hover {
      background: rgba(255,180,0,0.13);
      border-color: rgba(255,180,0,0.8);
    }

    .admin-input:focus,
    .admin-select:focus {
      border-color: #ffb400;
      box-shadow: 0 0 0 2.5px rgba(255,180,0,0.25);
      background: rgba(255,180,0,0.12);
    }

    /* í¬ê¸° ë³€í˜• */
    .admin-input.reading-input {
      font-family: 'Noto Serif JP', serif;
      font-size: 11px;
      max-width: 88px;
    }

    .admin-input.surface-input {
      font-family: 'Noto Serif JP', serif;
      font-weight: 700;
    }

    .admin-input.lg {
      font-size: 16px;
      max-width: 160px;
      text-align: center;
      padding: 4px 8px;
    }

    .admin-select.lg {
      font-size: 12px;
      max-width: 100px;
      padding: 4px 6px;
    }

    /* ì €ì¥ ì„±ê³µ í”¼ë“œë°± */
    .admin-input.saved {
      border-color: #00e676 !important;
      box-shadow: 0 0 0 2px rgba(0,230,118,0.22) !important;
    }

    /* ê´€ë¦¬ì ëª¨ë“œì¼ ë•Œ token-card ì—ë””í„°ë¸” í‘œì‹œ */
    body.admin-mode .token-card {
      outline: 1px dashed rgba(255,180,0,0.2);
      outline-offset: 2px;
    }

    /* íŒ¨ìŠ¤ì›Œë“œ ëª¨ë‹¬ ì¬í™œìš© (lang-modal-box í´ë¡ ) */
    #adminModal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    #adminModal.visible {
      display: flex;
    }

    .admin-modal-box {
      position: relative;
      background: var(--surface);
      border: 1px solid rgba(255,180,0,0.35);
      border-radius: 16px;
      padding: 36px 32px 28px;
      max-width: 320px;
      width: 90%;
      text-align: center;
      box-shadow: 0 24px 60px rgba(0,0,0,0.55);
      animation: slideUp 0.22s cubic-bezier(0.34,1.56,0.64,1);
    }

    .admin-modal-title {
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 18px;
    }

    .admin-pw-input {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 20px;
      font-family: 'DM Mono', monospace;
      text-align: center;
      letter-spacing: 0.3em;
      padding: 10px;
      outline: none;
      margin-bottom: 10px;
      box-sizing: border-box;
      transition: border-color 0.15s;
    }

    .admin-pw-input:focus {
      border-color: #ffb400;
    }

    .admin-pw-input.error {
      border-color: #ff4d6d;
      animation: shake 0.3s ease;
    }

    @keyframes shake {
      0%,100% { transform: translateX(0); }
      25%      { transform: translateX(-6px); }
      75%      { transform: translateX(6px); }
    }

    @keyframes dictUpdatedFlash {
      0%   { color: #00e676; text-shadow: 0 0 8px rgba(0,230,118,0.7); }
      100% { color: inherit; text-shadow: none; }
    }
    .dict-updated-flash {
      animation: dictUpdatedFlash 1.2s ease-out forwards;
    }

    .admin-pw-error {
      font-size: 12px;
      color: #ff4d6d;
      height: 16px;
      margin-bottom: 14px;
    }

    .admin-modal-btns {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .admin-modal-btns button {
      border-radius: 8px;
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 13px;
      font-weight: 600;
      padding: 9px 24px;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.12s;
      border: none;
    }

    .admin-modal-btns button:hover {
      opacity: 0.85;
      transform: translateY(-1px);
    }

    .btn-admin-confirm {
      background: #ffb400;
      color: #1a1200;
    }

    .btn-admin-cancel {
      background: var(--surface2);
      color: var(--muted);
      border: 1px solid var(--border) !important;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë‹¨ì–´ ì¶”ê°€ ëª¨ë‹¬
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #wordAddModal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    #wordAddModal.visible {
      display: flex;
    }

    .word-add-box {
      position: relative;
      background: var(--surface);
      border: 1px solid rgba(255,180,0,0.35);
      border-radius: 16px;
      padding: 32px 28px 24px;
      max-width: 460px;
      width: 94%;
      box-shadow: 0 24px 60px rgba(0,0,0,0.55);
      animation: slideUp 0.22s cubic-bezier(0.34,1.56,0.64,1);
    }

    .word-add-title {
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 15px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .word-add-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .word-add-field {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .word-add-field.full {
      grid-column: 1 / -1;
    }

    .word-add-label {
      font-size: 10px;
      font-family: 'DM Mono', monospace;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .word-add-input {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      font-family: 'Noto Serif JP', serif;
      font-size: 14px;
      padding: 8px 10px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      box-sizing: border-box;
      width: 100%;
    }

    .word-add-input:focus {
      border-color: #ffb400;
      box-shadow: 0 0 0 2px rgba(255,180,0,0.18);
    }

    .word-add-select {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      padding: 8px 10px;
      outline: none;
      cursor: pointer;
      transition: border-color 0.15s;
      box-sizing: border-box;
      width: 100%;
    }

    .word-add-select:focus {
      border-color: #ffb400;
    }

    .word-add-btns {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 4px;
    }

    .word-add-btns button {
      border-radius: 8px;
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 13px;
      font-weight: 600;
      padding: 9px 20px;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.12s;
      border: none;
    }

    .word-add-btns button:hover {
      opacity: 0.85;
      transform: translateY(-1px);
    }

    .btn-word-add-confirm {
      background: #ffb400;
      color: #1a1200;
    }

    .btn-word-add-cancel {
      background: var(--surface2);
      color: var(--muted);
      border: 1px solid var(--border) !important;
    }

    .word-add-error {
      font-size: 12px;
      color: #ff4d6d;
      min-height: 16px;
      margin-bottom: 10px;
      font-family: 'Noto Sans KR', sans-serif;
    }

    /* ë“±ë¡ëœ ë‹¨ì–´ ëª©ë¡ */
    .custom-words-section {
      margin-top: 20px;
      border-top: 1px solid var(--border);
      padding-top: 16px;
    }

    .custom-words-header {
      font-size: 11px;
      font-family: 'DM Mono', monospace;
      color: var(--muted);
      letter-spacing: 0.08em;
      margin-bottom: 10px;
    }

    .custom-words-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 180px;
      overflow-y: auto;
    }

    .custom-word-row {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface2);
      border-radius: 8px;
      padding: 7px 10px;
      font-size: 12px;
    }

    .custom-word-surface {
      font-family: 'Noto Serif JP', serif;
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      min-width: 60px;
    }

    .custom-word-reading {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      flex: 1;
    }

    .custom-word-lv {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 4px;
    }

    .custom-word-kr {
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 12px;
      color: var(--text);
      flex: 1;
    }

    .btn-custom-word-del {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 14px;
      padding: 0 2px;
      line-height: 1;
      transition: color 0.15s;
      flex-shrink: 0;
    }

    .btn-custom-word-del:hover {
      color: #ff4d6d;
    }

    .custom-words-empty {
      font-size: 12px;
      color: var(--muted);
      font-family: 'Noto Sans KR', sans-serif;
      text-align: center;
      padding: 8px 0;
    }

    /* íˆ´ë°” ë‹¨ì–´ ì¶”ê°€ ë²„íŠ¼ (ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) */
    #wordAddBtn {
      display: none;
    }

    body.admin-mode #wordAddBtn {
      display: flex;
    }

    /* íˆ´ë°” CSV ê¸°ì¤€ ì—…ë¡œë“œ ë²„íŠ¼ (ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) */
    #criteriaBtn {
      display: none;
      font-size: 12px;
      width: auto;
      padding: 0 10px;
      gap: 4px;
      white-space: nowrap;
      background: rgba(96,160,255,0.08);
      border-color: rgba(96,160,255,0.35);
      color: #7ab4ff;
    }

    body.admin-mode #criteriaBtn {
      display: flex;
    }

    #criteriaBtn:hover {
      background: rgba(96,160,255,0.18) !important;
      border-color: rgba(96,160,255,0.7) !important;
      color: #a8d0ff !important;
    }

    /* ê¸°ì¤€ ì ìš© ì¤‘ì¼ ë•Œ ê°•ì¡° */
    #criteriaBtn.criteria-active {
      background: rgba(255,180,0,0.10);
      border-color: rgba(255,180,0,0.50);
      color: #ffb400;
    }

    #criteriaBtn.criteria-active:hover {
      background: rgba(255,180,0,0.20) !important;
      border-color: #ffb400 !important;
      color: #ffb400 !important;
    }

    /* â”€â”€ CSV ë¶„ë¥˜ê¸°ì¤€ ì—…ë¡œë“œ ëª¨ë‹¬ â”€â”€ */
    #criteriaModal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9000;
    }

    #criteriaModal.visible {
      display: block;
    }

    .criteria-modal-box {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: 18px;
      padding: 28px 28px 22px;
      width: min(560px, 94vw);
      max-height: 85vh;
      overflow-y: auto;
      z-index: 9001;
      box-shadow: 0 12px 48px rgba(0,0,0,0.5);
    }

    .criteria-modal-title {
      font-family: 'DM Mono', monospace;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: 0.06em;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ë“œë˜ê·¸&ë“œë¡­ ì˜ì—­ */
    .criteria-drop-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 28px 16px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      background: var(--surface2);
      margin-bottom: 14px;
    }

    .criteria-drop-zone:hover,
    .criteria-drop-zone.drag-over {
      border-color: #ffb400;
      background: rgba(255,180,0,0.07);
    }

    .criteria-drop-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .criteria-drop-text {
      font-size: 12px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
    }

    .criteria-drop-text strong {
      color: #ffb400;
      cursor: pointer;
    }

    #criteriaFileInput {
      display: none;
    }

    /* í˜„ì¬ ê¸°ì¤€ ìƒíƒœ ë°°ì§€ */
    .criteria-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      font-family: 'DM Mono', monospace;
      color: var(--muted);
      margin-bottom: 12px;
      padding: 8px 10px;
      background: var(--surface2);
      border-radius: 8px;
    }

    .criteria-status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .criteria-status-dot.active {
      background: #00e676;
    }

    .criteria-status-dot.inactive {
      background: var(--muted);
    }

    /* ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” */
    .criteria-preview-wrap {
      margin-bottom: 14px;
    }

    .criteria-preview-label {
      font-size: 10px;
      font-family: 'DM Mono', monospace;
      color: var(--muted);
      letter-spacing: 0.05em;
      margin-bottom: 6px;
    }

    .criteria-preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      font-family: 'DM Mono', monospace;
    }

    .criteria-preview-table th {
      background: rgba(255,180,0,0.15);
      color: #ffb400;
      font-weight: 600;
      padding: 5px 8px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .criteria-preview-table td {
      padding: 4px 8px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }

    .criteria-preview-table tr:last-child td {
      border-bottom: none;
    }

    .criteria-preview-table tr:nth-child(even) td {
      background: var(--surface2);
    }

    .criteria-preview-more {
      font-size: 10px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      text-align: right;
      margin-top: 4px;
    }

    .criteria-parse-error {
      font-size: 11px;
      color: #ff4d6d;
      font-family: 'DM Mono', monospace;
      margin-bottom: 10px;
      min-height: 16px;
    }

    /* ê¸°ì¤€ ì´ë¦„ ì…ë ¥ */
    .criteria-name-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
    }

    .criteria-name-label {
      font-size: 11px;
      font-family: 'DM Mono', monospace;
      color: var(--muted);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .criteria-name-input {
      flex: 1;
      background: var(--surface2);
      border: 1.5px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 12px;
      padding: 5px 10px;
      outline: none;
      transition: border-color 0.15s;
    }

    .criteria-name-input:focus {
      border-color: #ffb400;
    }

    /* ëª¨ë‹¬ ë²„íŠ¼ í–‰ */
    .criteria-modal-btns {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 4px;
    }

    .btn-criteria-cancel {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--muted);
      font-size: 12px;
      font-family: 'DM Mono', monospace;
      padding: 7px 16px;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s;
    }

    .btn-criteria-cancel:hover {
      border-color: var(--muted);
      color: var(--text);
    }

    .btn-criteria-clear {
      background: transparent;
      border: 1px solid rgba(255,77,109,0.4);
      border-radius: 8px;
      color: #ff4d6d;
      font-size: 12px;
      font-family: 'DM Mono', monospace;
      padding: 7px 16px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .btn-criteria-clear:hover {
      background: rgba(255,77,109,0.08);
    }

    .btn-criteria-apply {
      background: #ffb400;
      border: none;
      border-radius: 8px;
      color: #1a1000;
      font-size: 12px;
      font-weight: 700;
      font-family: 'DM Mono', monospace;
      padding: 7px 20px;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .btn-criteria-apply:hover {
      opacity: 0.88;
    }

    .btn-criteria-apply:disabled {
      opacity: 0.35;
      cursor: not-allowed;
    }

    /* ë²”ë¡€ì— ê¸°ì¤€ëª… ë°°ì§€ */
    .legend-criteria-badge {
      display: none;
      font-size: 10px;
      font-family: 'DM Mono', monospace;
      color: #ffb400;
      background: rgba(255,180,0,0.12);
      border: 1px solid rgba(255,180,0,0.35);
      border-radius: 6px;
      padding: 2px 8px;
      margin-left: 4px;
      letter-spacing: 0.04em;
    }

    .legend-criteria-badge.visible {
      display: inline-block;
    }
  </style>
</head>
<body>

<div class="container">

  <!-- íˆ´ë°”: ë¼ì´íŠ¸/ë‹¤í¬ + ë‹¨ì–´ì¶”ê°€ + ê´€ë¦¬ì -->
  <div id="toolbar">
    <button class="tb-btn" id="themeBtn" onclick="toggleTheme()" title="ë¼ì´íŠ¸/ë‹¤í¬ ëª¨ë“œ ì „í™˜">ğŸŒ™</button>
    <button class="tb-btn" id="wordAddBtn" onclick="openWordAddModal()" title="ë‹¨ì–´ ì¶”ê°€">ï¼‹</button>
    <button class="tb-btn" id="adminBtn" onclick="openAdminModal()" title="ê´€ë¦¬ì ëª¨ë“œ">ğŸ”’</button>
    <button class="tb-btn" id="dictDownloadBtn" onclick="downloadDictCSV()" title="ì „ì²´ ì‚¬ì „ CSV ë‹¤ìš´ë¡œë“œ">â¬‡ ì‚¬ì „</button>
    <button class="tb-btn" id="criteriaBtn" onclick="openCriteriaModal()" title="ë ˆë²¨ ë¶„ë¥˜ ê¸°ì¤€ CSV ì—…ë¡œë“œ">ğŸ“‹ ê¸°ì¤€</button>
  </div>

  <!-- CSV ë ˆë²¨ ë¶„ë¥˜ê¸°ì¤€ ì—…ë¡œë“œ ëª¨ë‹¬ -->
  <div id="criteriaModal" role="dialog" aria-modal="true" aria-labelledby="criteriaModalTitle">
    <div class="lang-modal-backdrop" onclick="closeCriteriaModal()"></div>
    <div class="criteria-modal-box">
      <div class="criteria-modal-title">
        <span>ğŸ“‹</span>
        <span id="criteriaModalTitle">ë ˆë²¨ ë¶„ë¥˜ê¸°ì¤€ CSV ì—…ë¡œë“œ</span>
      </div>

      <!-- í˜„ì¬ ì ìš© ê¸°ì¤€ ìƒíƒœ -->
      <div class="criteria-status" id="criteriaStatus">
        <span class="criteria-status-dot inactive" id="criteriaStatusDot"></span>
        <span id="criteriaStatusText">í˜„ì¬ ì ìš©ëœ ê¸°ì¤€ ì—†ìŒ (ê¸°ë³¸ JLPT ì‚¬ì „ ì‚¬ìš©)</span>
      </div>

      <!-- ë“œë˜ê·¸&ë“œë¡­ / íŒŒì¼ ì„ íƒ ì˜ì—­ -->
      <div class="criteria-drop-zone" id="criteriaDropZone"
           onclick="document.getElementById('criteriaFileInput').click()"
           ondragover="event.preventDefault();this.classList.add('drag-over')"
           ondragleave="this.classList.remove('drag-over')"
           ondrop="event.preventDefault();this.classList.remove('drag-over');handleCriteriaFileDrop(event)">
        <div class="criteria-drop-icon">ğŸ“„</div>
        <div class="criteria-drop-text">
          CSV íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜<br>
          <strong onclick="event.stopPropagation();document.getElementById('criteriaFileInput').click()">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</strong>
        </div>
        <div class="criteria-drop-text" style="margin-top:6px;font-size:10px;">
          í˜•ì‹: ì½ê¸°(íˆë¼ê°€ë‚˜), í•œì, ë¶„ë¥˜ê¸°ì¤€(N1~N5 ë˜ëŠ” ì»¤ìŠ¤í…€)
        </div>
      </div>
      <input type="file" id="criteriaFileInput" accept=".csv,.txt"
             onchange="handleCriteriaFileSelect(event)">

      <!-- íŒŒì‹± ì˜¤ë¥˜ -->
      <div class="criteria-parse-error" id="criteriaParseError"></div>

      <!-- ê¸°ì¤€ ì´ë¦„ ì…ë ¥ -->
      <div class="criteria-name-row">
        <span class="criteria-name-label">ê¸°ì¤€ ì´ë¦„:</span>
        <input type="text" id="criteriaNameInput" class="criteria-name-input"
               placeholder="ì˜ˆ) êµì¬ A â€” ë ˆë²¨ ê¸°ì¤€" maxlength="40"
               onkeydown="if(event.key==='Escape')closeCriteriaModal()">
      </div>

      <!-- ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” -->
      <div class="criteria-preview-wrap" id="criteriaPreviewWrap" style="display:none">
        <div class="criteria-preview-label">PREVIEW â€” íŒŒì‹±ëœ í•­ëª© (ìƒìœ„ 10ê°œ)</div>
        <table class="criteria-preview-table">
          <thead>
            <tr>
              <th>ì½ê¸°</th><th>í•œì</th><th>ë¶„ë¥˜ê¸°ì¤€</th>
            </tr>
          </thead>
          <tbody id="criteriaPreviewBody"></tbody>
        </table>
        <div class="criteria-preview-more" id="criteriaPreviewMore"></div>
      </div>

      <!-- ë²„íŠ¼ í–‰ -->
      <div class="criteria-modal-btns">
        <button class="btn-criteria-cancel" onclick="closeCriteriaModal()">ë‹«ê¸°</button>
        <button class="btn-criteria-clear" onclick="clearCriteria()" id="criteriaClearBtn">ê¸°ì¤€ ì´ˆê¸°í™”</button>
        <button class="btn-criteria-apply" id="criteriaApplyBtn" disabled onclick="applyCriteriaParsed()">ì ìš©</button>
      </div>
    </div>
  </div>

  <!-- ê´€ë¦¬ì íŒ¨ìŠ¤ì›Œë“œ ëª¨ë‹¬ -->
  <div id="adminModal" role="dialog" aria-modal="true">
    <div class="lang-modal-backdrop" onclick="closeAdminModal()"></div>
    <div class="admin-modal-box">
      <div class="lang-modal-icon" id="adminModalIcon">ğŸ”</div>
      <div class="admin-modal-title" id="adminModalTitle">ê´€ë¦¬ì ëª¨ë“œ</div>
      <input type="password" id="adminPwInput" class="admin-pw-input"
             placeholder="Â·Â·Â·Â·" maxlength="10"
             onkeydown="if(event.key==='Enter')confirmAdmin();if(event.key==='Escape')closeAdminModal();">
      <div class="admin-pw-error" id="adminPwError"></div>
      <div class="admin-modal-btns">
        <button class="btn-admin-cancel" onclick="closeAdminModal()">ì·¨ì†Œ</button>
        <button class="btn-admin-confirm" onclick="confirmAdmin()">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ë‹¨ì–´ ì¶”ê°€ ëª¨ë‹¬ -->
  <div id="wordAddModal" role="dialog" aria-modal="true" aria-labelledby="wordAddTitle">
    <div class="lang-modal-backdrop" onclick="closeWordAddModal()"></div>
    <div class="word-add-box">
      <div class="word-add-title">
        <span>ğŸ“</span>
        <span id="wordAddTitle">ë‹¨ì–´ ì¶”ê°€</span>
      </div>

      <!-- ì…ë ¥ í¼ -->
      <div class="word-add-grid">
        <div class="word-add-field">
          <label class="word-add-label" for="wa-surface">í‘œì¸µí˜• (í•œì/ê°€ë‚˜)</label>
          <input id="wa-surface" class="word-add-input" type="text"
                 placeholder="ä¾‹: ãŠç”°" autocomplete="off"
                 onkeydown="if(event.key==='Enter')saveCustomWord();else if(event.key==='Escape')closeWordAddModal();">
        </div>
        <div class="word-add-field">
          <label class="word-add-label" for="wa-reading">ì½ê¸° (íˆë¼ê°€ë‚˜)</label>
          <input id="wa-reading" class="word-add-input" type="text"
                 placeholder="ä¾‹: ãŠã§ã‚“" autocomplete="off"
                 onkeydown="if(event.key==='Enter')saveCustomWord();else if(event.key==='Escape')closeWordAddModal();">
        </div>
        <div class="word-add-field">
          <label class="word-add-label" for="wa-level">JLPT ë ˆë²¨</label>
          <select id="wa-level" class="word-add-select">
            <option value="N5">N5 ì´ˆê¸‰</option>
            <option value="N4">N4 ì´ˆì¤‘ê¸‰</option>
            <option value="N3" selected>N3 ì¤‘ê¸‰</option>
            <option value="N2">N2 ì¤‘ìƒê¸‰</option>
            <option value="N1">N1 ìƒê¸‰</option>
            <option value="å¤–">å¤– ë¯¸ë“±ì¬</option>
          </select>
        </div>
        <div class="word-add-field">
          <label class="word-add-label" for="wa-pos">í’ˆì‚¬</label>
          <select id="wa-pos" class="word-add-select">
            <option value="åè©" selected>åè©</option>
            <option value="å‹•è©">å‹•è©</option>
            <option value="å½¢å®¹è©">å½¢å®¹è©</option>
            <option value="å‰¯è©">å‰¯è©</option>
            <option value="åŠ©è©">åŠ©è©</option>
            <option value="åŠ©å‹•è©">åŠ©å‹•è©</option>
            <option value="æ¥ç¶šè©">æ¥ç¶šè©</option>
            <option value="æ„Ÿå‹•è©">æ„Ÿå‹•è©</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="word-add-field full">
          <label class="word-add-label" for="wa-korean">í•œêµ­ì–´ ëœ»</label>
          <input id="wa-korean" class="word-add-input" type="text"
                 placeholder="ä¾‹: ì–´ë¬µ, ì˜¤ë…" autocomplete="off"
                 onkeydown="if(event.key==='Enter')saveCustomWord();else if(event.key==='Escape')closeWordAddModal();">
        </div>
      </div>

      <div class="word-add-error" id="wordAddError"></div>

      <div class="word-add-btns">
        <button class="btn-word-add-cancel" onclick="closeWordAddModal()">ë‹«ê¸°</button>
        <button class="btn-word-add-confirm" onclick="saveCustomWord()">ì¶”ê°€</button>
      </div>

      <!-- ë“±ë¡ëœ ë‹¨ì–´ ëª©ë¡ -->
      <div class="custom-words-section">
        <div class="custom-words-header">ë“±ë¡ëœ ë‹¨ì–´ (<span id="customWordsCount">0</span>ê°œ)</div>
        <div class="custom-words-list" id="customWordsList"></div>
      </div>
    </div>
  </div>

  <!-- â‘  í—¤ë” ì˜ì—­ -->
  <header class="header">
    <div class="badge">
      <span class="badge-dot"></span>
      TANGOYAï¼ˆå˜èªå±‹ï¼‰
    </div>
    <h1 class="header-title">TANGOYAï¼ˆå˜èªå±‹ï¼‰</h1>
    <p class="header-subtitle">
      ì¼ë³¸ì–´ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ë©´ í˜•íƒœì†Œ ë¶„ì„ í›„ JLPT ë ˆë²¨ì„ íŒì •í•©ë‹ˆë‹¤
    </p>
    <div id="adminBadge">
      <span class="admin-dot"></span>
      ADMIN MODE
    </div>
  </header>

  <!-- â‘¡ ë ˆë²¨ ë²”ë¡€ -->
  <nav class="legend" aria-label="JLPT ë ˆë²¨ ë²”ë¡€">
    <div class="legend-item">
      <span class="legend-dot" style="background:var(--N1)"></span>
      <span class="lv-label">N1</span>
      <span id="legendLabelN1">ìƒê¸‰</span>
    </div>
    <div class="legend-item">
      <span class="legend-dot" style="background:var(--N2)"></span>
      <span class="lv-label">N2</span>
      <span id="legendLabelN2">ì¤‘ìƒê¸‰</span>
    </div>
    <div class="legend-item">
      <span class="legend-dot" style="background:var(--N3)"></span>
      <span class="lv-label">N3</span>
      <span id="legendLabelN3">ì¤‘ê¸‰</span>
    </div>
    <div class="legend-item">
      <span class="legend-dot" style="background:var(--N4)"></span>
      <span class="lv-label">N4</span>
      <span id="legendLabelN4">ì´ˆì¤‘ê¸‰</span>
    </div>
    <div class="legend-item">
      <span class="legend-dot" style="background:var(--N5)"></span>
      <span class="lv-label">N5</span>
      <span id="legendLabelN5">ì´ˆê¸‰</span>
    </div>
    <div class="legend-item">
      <span class="legend-dot" style="background:var(--EX)"></span>
      <span class="lv-label">å¤–</span>
      <span>ë¯¸ë“±ì¬</span>
    </div>
    <span class="legend-criteria-badge" id="legendCriteriaBadge"></span>
  </nav>

  <!-- â‘¢ ì…ë ¥ ì¹´ë“œ -->
  <section class="card" aria-label="ì…ë ¥ ì˜ì—­">
    <label class="card-label" for="inputText">ì¼ë³¸ì–´ ì…ë ¥</label>
    <div class="input-row">
      <textarea
        id="inputText"
        maxlength="1000"
        placeholder="ì˜ˆ) ä¼šã†ã€€ã€€ë˜ëŠ”ã€€ã€€ç§ã¯å­¦ç”Ÿã§ã™"
        spellcheck="false"
        autocomplete="off"
      ></textarea>
      <div class="input-btn-col">
        <button id="analyzeBtn" onclick="analyze()">ë¶„ì„í•˜ê¸°</button>
        <button id="resetBtn"   onclick="resetAll()">â†º ì´ˆê¸°í™”</button>
      </div>
    </div>
  </section>

  <!-- â‘£ ì—ëŸ¬ ë©”ì‹œì§€ -->
  <div id="errorMsg" role="alert" aria-live="polite"></div>

  <!-- â‘¤ ë¡œë”© -->
  <div id="loading" aria-live="polite" aria-label="ë¶„ì„ ì¤‘">
    <div class="spinner"></div>
    <span>í˜•íƒœì†Œ ë¶„ì„ ì¤‘...</span>
  </div>

  <!-- â‘¥ ê²°ê³¼ ì˜ì—­ -->
  <section id="resultArea" aria-label="ë¶„ì„ ê²°ê³¼">
    <div id="resultContent"></div>

    <!-- ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ -->
    <div class="download-section">
      <span class="download-label">EXPORT</span>
      <button class="btn-download" onclick="downloadJSON()">â¬‡ JSON</button>
      <button class="btn-download" onclick="downloadCSV()">â¬‡ CSV</button>
      <button class="btn-download" onclick="downloadTXT()">â¬‡ TXT</button>
      <button class="btn-reset-edits" onclick="resetKrEdits()" title="ì €ì¥ëœ í•œêµ­ì–´ ëœ» ìˆ˜ì • ë‚´ì—­ì„ ëª¨ë‘ ì´ˆê¸°í™”">â†º ìˆ˜ì • ì´ˆê¸°í™”</button>
    </div>
  </section>

  <!-- ì•± í‘¸í„° -->
  <footer class="app-footer" aria-label="ì•± ì •ë³´">
    <span class="app-footer-item">ê°œë°œì <strong>Jaehyoring</strong></span>
    <span class="app-footer-sep">Â·</span>
    <span class="app-footer-item">ë²„ì „ <strong>v1.0</strong></span>
    <span class="app-footer-sep">Â·</span>
    <span class="app-footer-item">ì¼ë³¸ì–´ ë‹¨ì–´ íŒë³„ ê¸°ì¤€ <strong id="footerCriteriaName">ë„¤ì´ë²„ ì¼ë³¸ì–´ ì‚¬ì „</strong></span>
    <span class="app-footer-sep">Â·</span>
    <span class="app-footer-item">ì‚¬ì „ ê°±ì‹ ì¼ <strong id="footerDictUpdated">-</strong></span>
  </footer>

</div><!-- /.container -->

<!-- í•œêµ­ì–´ ì…ë ¥ ê²½ê³  ëª¨ë‹¬ -->
<div id="langModal" role="dialog" aria-modal="true" aria-labelledby="langModalTitle">
  <div class="lang-modal-backdrop" onclick="closeLangModal()"></div>
  <div class="lang-modal-box">
    <div class="lang-modal-icon">ğŸ‡¯ğŸ‡µ</div>
    <div class="lang-modal-title" id="langModalTitle">ì¼ë³¸ì–´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”</div>
    <div class="lang-modal-desc">
      ì´ ì•±ì€ <strong style="color:var(--text)">ì¼ë³¸ì–´ í…ìŠ¤íŠ¸</strong>ë§Œ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
      ì…ë ¥ì°½ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
    </div>
    <button class="lang-modal-btn" onclick="closeLangModal()">í™•ì¸</button>
  </div>
</div>

<script>
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ì‘ì—… 1: JLPT_DICT ë‚´ì¥ ë°ì´í„°
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let JLPT_DICT = {};

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ì‘ì—… 2: Kuromoji ì´ˆê¸°í™”
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let tokenizer   = null;
  let initFailed  = false;

  function initKuromoji() {
    return new Promise((resolve, reject) => {
      kuromoji
        .builder({ dicPath: 'dict' })
        .build((err, _tokenizer) => {
          if (err) {
            // errê°€ Event ê°ì²´(XHR onerror)ì´ê±°ë‚˜ ë¬¸ìì—´ì¼ ìˆ˜ ìˆìŒ
            const msg = (err && err.message) ? err.message
                      : (typeof err === 'string') ? err
                      : 'ì‚¬ì „ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨';
            reject(new Error(msg));
            return;
          }
          resolve(_tokenizer);
        });
    });
  }

  /** kuromoji ì „ì—­ ë³€ìˆ˜ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ìµœëŒ€ 10ì´ˆ ëŒ€ê¸° */
  function waitForKuromoji(timeout = 10000) {
    return new Promise((resolve, reject) => {
      if (typeof kuromoji !== 'undefined') { resolve(); return; }
      const start = Date.now();
      const check = setInterval(() => {
        if (typeof kuromoji !== 'undefined') { clearInterval(check); resolve(); }
        else if (Date.now() - start > timeout) { clearInterval(check); reject(new Error('kuromoji is not defined')); }
      }, 50);
    });
  }

  (async () => {
    try {
      // file:// í”„ë¡œí† ì½œ ê²½ê³ 
      if (location.protocol === 'file:') {
        showError(
          'file:// í”„ë¡œí† ì½œë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ì‚¬ì „ íŒŒì¼ ë¡œë“œê°€ ì°¨ë‹¨ë©ë‹ˆë‹¤.<br>' +
          '<strong>python3 dist/start_server.py</strong> ë¡œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.'
        );
        initFailed = true;
        const btn = document.getElementById('analyzeBtn');
        if (btn) { btn.disabled = true; btn.style.opacity = '0.4'; }
        return;
      }
      // JLPT_DICTë¥¼ jlpt_dict.jsonì—ì„œ ë¹„ë™ê¸° ë¡œë“œ (ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡œí‚¹ ë°©ì§€)
      const dictResp = await fetch('jlpt_dict.json');
      if (!dictResp.ok) throw new Error('jlpt_dict.json ë¡œë“œ ì‹¤íŒ¨: ' + dictResp.status);
      Object.assign(JLPT_DICT, await dictResp.json());
      applyStoredEdits();    // í•œêµ­ì–´ ëœ» ì‚¬ìš©ì í¸ì§‘ ë°˜ì˜
      applyCustomWords();    // ì»¤ìŠ¤í…€ ë‹¨ì–´ ë°˜ì˜
      applyStoredCriteria(); // ë¶„ë¥˜ê¸°ì¤€ ë°˜ì˜
      await waitForKuromoji();
      tokenizer = await initKuromoji();
      console.log('tangoya ì¤€ë¹„ ì™„ë£Œ:', Object.keys(JLPT_DICT).length, 'ê°œ ë‹¨ì–´');
    } catch (err) {
      initFailed = true;
      const btn = document.getElementById('analyzeBtn');
      if (btn) { btn.disabled = true; btn.style.opacity = '0.4'; }
      const detail = err.message || String(err);
      showError('í˜•íƒœì†Œ ë¶„ì„ê¸° ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + detail);
      console.error('Kuromoji ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
    }
  })();

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ì‘ì—… 3: ë³´ì¡° í•¨ìˆ˜
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /** íˆë¼ê°€ë‚˜ â†’ ì¹´íƒ€ì¹´ë‚˜ ë³€í™˜ */
  function toKatakana(str) {
    return str.replace(REGEX.HIRAGANA, ch =>
      String.fromCharCode(ch.charCodeAt(0) + 0x60)
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ì „ì—­ ìƒìˆ˜
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /** ì¡°ì‚¬Â·ì¡°ë™ì‚¬ ë“± í•­ìƒ æ–‡æ³•ìœ¼ë¡œ ì²˜ë¦¬í•  í’ˆì‚¬ ëª©ë¡ */
  const GRAMMAR_POS = ['åŠ©è©', 'åŠ©å‹•è©', 'è¨˜å·', 'æ¥ç¶šè©'];

  /** ì•± ë™ì‘ ê´€ë ¨ ì„¤ì •ê°’ */
  const CONFIG = {
    ADMIN_ERROR_CLEAR_MS:   1200,   // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜ í‘œì‹œ ì§€ì† ì‹œê°„
    LANG_MODAL_FOCUS_MS:      50,   // ì–¸ì–´ ê²½ê³  ëª¨ë‹¬ í¬ì»¤ìŠ¤ ë”œë ˆì´
    ADMIN_MODAL_FOCUS_MS:     60,   // ê´€ë¦¬ì ëª¨ë‹¬ í¬ì»¤ìŠ¤ ë”œë ˆì´
    ADMIN_SAVED_FLASH_MS:    700,   // ì €ì¥ ì™„ë£Œ ì´ˆë¡ í…Œë‘ë¦¬ ì§€ì† ì‹œê°„
    SERVER_PING_INTERVAL_MS: 3000,  // ì„œë²„ íƒ­ ë‹«í˜ ê°ì§€ í´ë§ ì£¼ê¸°
  };

  /** ì •ê·œì‹ ìƒìˆ˜ â€” ë°˜ë³µ ì»´íŒŒì¼ ë°©ì§€ */
  const REGEX = {
    HIRAGANA:      /[\u3041-\u3096]/g,
    KATAKANA:      /[\u30A1-\u30F6]/g,
    JAPANESE:      /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF\u3400-\u4DBF\uF900-\uFAFF]/,
    DOT_SEPARATOR: /[Â·ãƒ»]/,
    ALLOWED_CHARS: /[\x00-\x7F\u3000-\u303F\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF\u3400-\u4DBF\uF900-\uFAFF\uFF00-\uFFEF]/,
  };

  /** í…Œë§ˆë³„ ë ˆë²¨ ìƒ‰ìƒí‘œ */
  const COLOR_SCHEMES = {
    dark:  { N1: '#ff4d6d', N2: '#ff8800', N3: '#ffd600', N4: '#00e676', N5: '#40c4ff', 'å¤–': '#6060a0', 'æ–‡æ³•': '#444466' },
    light: { N1: '#d62b4b', N2: '#c86000', N3: '#9a8200', N4: '#00a050', N5: '#0090cc', 'å¤–': '#5050a0', 'æ–‡æ³•': '#444466' },
  };

  /** JLPT_DICT ê²€ìƒ‰: {r, l, k} ë˜ëŠ” null ë°˜í™˜ */
  // ë ˆë²¨ ìš°ì„ ìˆœìœ„: N5ê°€ ê°€ì¥ ë‚®ì€ ê¸‰ìˆ˜(ì´ˆê¸‰) = ìµœìš°ì„ 
  const LEVEL_RANK = { N5: 1, N4: 2, N3: 3, N2: 4, N1: 5, 'å¤–': 6, 'æ–‡æ³•': 7 };

  function lookupWord(surface, baseForm, reading) {
    const candidates = [baseForm, surface, reading].filter(Boolean);
    let best = null;

    function keepLowest(entry) {
      if (!entry) return;
      if (!best) { best = entry; return; }
      const r1 = LEVEL_RANK[entry.l] ?? 9;
      const r2 = LEVEL_RANK[best.l]  ?? 9;
      if (r1 < r2) best = entry;
    }

    for (const key of candidates) {
      // 1~3. ì§ì ‘ ì¡°íšŒ
      keepLowest(JLPT_DICT[key]);

      // 4. 'Â·' 'ãƒ»' í¬í•¨ ì‹œ ë¶„ë¦¬ í›„ ê° ë¶€ë¶„ ì¡°íšŒ
      if (key && (key.includes('Â·') || key.includes('ãƒ»'))) {
        for (const part of key.split(REGEX.DOT_SEPARATOR)) {
          if (part) keepLowest(JLPT_DICT[part]);
        }
      }

      // 5. ì¹´íƒ€ì¹´ë‚˜ ë³€í™˜ í›„ ì¬ì¡°íšŒ
      if (key) {
        const kata = toKatakana(key);
        if (kata !== key) keepLowest(JLPT_DICT[kata]);
      }
    }
    return best;
  }

  /** ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ */
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ì–¸ì–´ ê°ì§€ & ëª¨ë‹¬
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /** íˆë¼ê°€ë‚˜Â·ê°€íƒ€ì¹´ë‚˜Â·í•œìê°€ 1ìë¼ë„ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ true */
  function containsJapanese(str) {
    return REGEX.JAPANESE.test(str);
  }

  /**
   * ë¹„ASCIIì´ë©´ì„œ ì¼ë³¸ì–´Â·ì „ê° ë²”ìœ„ ë°–ì˜ ë¬¸ì(í•œê¸€Â·ì•„ëÂ·ëŸ¬ì‹œì•„ì–´ ë“±)ê°€
   * 1ìë¼ë„ í¬í•¨ë˜ë©´ true.
   */
  function hasForeignNonJapanese(str) {
    // í—ˆìš© ë²”ìœ„: ASCII ì „ì²´, ì¼ë³¸ì–´ êµ¬ë‘ì Â·ì „ê°, íˆë¼ê°€ë‚˜, ê°€íƒ€ì¹´ë‚˜, CJK í•œì, ì „ê° ASCII
    for (const ch of str) {
      if (!REGEX.ALLOWED_CHARS.test(ch)) return true;
    }
    return false;
  }

  function showLangModal() {
    document.getElementById('langModal').classList.add('visible');
    // ëª¨ë‹¬ ë²„íŠ¼ì— í¬ì»¤ìŠ¤
    setTimeout(() => {
      const btn = document.querySelector('.lang-modal-btn');
      if (btn) btn.focus();
    }, 50);
  }

  function closeLangModal() {
    document.getElementById('langModal').classList.remove('visible');
    // ì´ˆê¸°í™” í›„ textareaì— í¬ì»¤ìŠ¤
    const ta = document.getElementById('inputText');
    if (ta) { ta.value = ''; ta.focus(); }
  }

  // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      const modal = document.getElementById('langModal');
      if (modal && modal.classList.contains('visible')) {
        closeLangModal();
      }
    }
  });

  function showError(msg) {
    const el = document.getElementById('errorMsg');
    if (!el) return;
    el.textContent = msg;
    el.classList.add('visible');
  }

  /** ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸° */
  function hideError() {
    const el = document.getElementById('errorMsg');
    if (!el) return;
    el.textContent = '';
    el.classList.remove('visible');
  }

  /** ë¡œë”© í‘œì‹œ ì œì–´ */
  function showLoading(bool) {
    const el = document.getElementById('loading');
    if (!el) return;
    if (bool) { el.classList.add('visible'); }
    else       { el.classList.remove('visible'); }
  }


  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ìœ í‹¸ë¦¬í‹°
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function escHtml(str) {
    return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  /** ì¹´íƒ€ì¹´ë‚˜(U+30A1~U+30F6) â†’ íˆë¼ê°€ë‚˜ ë³€í™˜ */
  function toHiragana(str) {
    return (str||'').replace(REGEX.KATAKANA, ch =>
      String.fromCharCode(ch.charCodeAt(0) - 0x60)
    );
  }

  // lastResult: ë‹¤ìš´ë¡œë“œìš© ë¶„ì„ ê²°ê³¼ ë³´ê´€
  let lastResult = null;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // í•œêµ­ì–´ ëœ» ìˆ˜ë™ í¸ì§‘ â€” localStorage ëª¨ë“ˆ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const KR_EDITS_KEY      = 'tangoya_kr_edits';
  const MERGE_RULES_KEY   = 'tangoya_merge_rules';
  const CUSTOM_WORDS_KEY  = 'tangoya_custom_words';
  const DICT_UPDATED_KEY  = 'tangoya_dict_updated'; // ì‚¬ì „ ê°±ì‹ ì¼ { updated: 'YYYY-MM-DD' }

  /** í˜„ì¬ ë‚ ì§œ+ì‹œê°„(YYYY-MM-DD HH:MM)ì„ ì‚¬ì „ ê°±ì‹ ì¼ë¡œ ê¸°ë¡ */
  function touchDictUpdated() {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    const stamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} `
                + `${pad(now.getHours())}:${pad(now.getMinutes())}`;
    localStorage.setItem(DICT_UPDATED_KEY, stamp);
    // í‘¸í„° ê°±ì‹ ì¼ í‘œì‹œ ì—…ë°ì´íŠ¸ + í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼
    const el = document.getElementById('footerDictUpdated');
    if (el) {
      el.textContent = stamp;
      el.classList.remove('dict-updated-flash');
      // reflow ê°•ì œí•˜ì—¬ ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹¤í–‰
      void el.offsetWidth;
      el.classList.add('dict-updated-flash');
    }
  }

  /** ì €ì¥ëœ ì‚¬ì „ ê°±ì‹ ì¼ ë°˜í™˜. í•œ ë²ˆë„ ìˆ˜ì •í•œ ì  ì—†ìœ¼ë©´ '-' í‘œì‹œ */
  function getDictUpdated() {
    return localStorage.getItem(DICT_UPDATED_KEY) || '-';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // localStorage íŒ©í† ë¦¬ â€” ë‹¨ìˆœ JSON ìŠ¤í† ì–´ ê³µí†µ íŒ¨í„´
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /**
   * createStore(key, defaultValue)
   * â†’ { load(), save(data) } ë°˜í™˜
   * load: JSON.parse ì‹¤íŒ¨ ì‹œ defaultValue ë°˜í™˜
   * save: JSON.stringify í›„ setItem
   */
  function createStore(key, defaultValue) {
    return {
      load() {
        try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(defaultValue)); }
        catch(e) { return defaultValue; }
      },
      save(data) {
        localStorage.setItem(key, JSON.stringify(data));
      },
    };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // í† í° ë³‘í•© ê·œì¹™ â€” localStorage ëª¨ë“ˆ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ì €ì¥ í˜•ì‹: { "inputText": [[0,1],[3,4], ...], ... }
  // ê° ë°°ì—´ì€ "ë³‘í•© ì‹œì‘ ì¸ë±ìŠ¤ë“¤" (ì›ë³¸ rawTokens ê¸°ì¤€)

  const mergeStore = createStore(MERGE_RULES_KEY, {});
  function loadMergeRules() { return mergeStore.load(); }
  function saveMergeRules(rules) { mergeStore.save(rules); }

  /** íŠ¹ì • ì…ë ¥ í…ìŠ¤íŠ¸ì— ëŒ€í•œ ë³‘í•© ê·¸ë£¹ ëª©ë¡ ë°˜í™˜ (ì—†ìœ¼ë©´ []) */
  function getMergeGroups(inputText) {
    return loadMergeRules()[inputText] || [];
  }

  /**
   * ë‘ ì¸ë±ìŠ¤(i, i+1)ë¥¼ ë³‘í•© ê·¸ë£¹ì— ì¶”ê°€.
   * ì´ë¯¸ ê·¸ë£¹ì— ì†í•œ ì¸ë±ìŠ¤ë©´ ê·¸ ê·¸ë£¹ì„ í™•ì¥.
   */
  function addMerge(inputText, idxA, idxB) {
    const rules = loadMergeRules();
    if (!rules[inputText]) rules[inputText] = [];
    const groups = rules[inputText];

    // idxA ë˜ëŠ” idxBê°€ ê¸°ì¡´ ê·¸ë£¹ì— ì†í•˜ë©´ í•©ì¹¨
    let targetGroup = null;
    for (const g of groups) {
      if (g.includes(idxA) || g.includes(idxB)) {
        targetGroup = g;
        break;
      }
    }
    if (targetGroup) {
      if (!targetGroup.includes(idxA)) targetGroup.push(idxA);
      if (!targetGroup.includes(idxB)) targetGroup.push(idxB);
      targetGroup.sort((a,b) => a-b);
    } else {
      groups.push([idxA, idxB].sort((a,b) => a-b));
    }
    rules[inputText] = groups;
    saveMergeRules(rules);
  }

  /**
   * ì¸ë±ìŠ¤ idxê°€ ì†í•œ ë³‘í•© ê·¸ë£¹ì„ ì‚­ì œ (ë³‘í•© ì·¨ì†Œ).
   */
  function removeMerge(inputText, idx) {
    const rules = loadMergeRules();
    if (!rules[inputText]) return;
    rules[inputText] = rules[inputText].filter(g => !g.includes(idx));
    if (rules[inputText].length === 0) delete rules[inputText];
    saveMergeRules(rules);
  }

  /**
   * ë³‘í•© ê·¸ë£¹ì„ ì›ë³¸ tokens ë°°ì—´ì— ì ìš©í•˜ì—¬
   * ë³‘í•©ëœ ìƒˆ tokens ë°°ì—´ ë°˜í™˜.
   * ê° ë³‘í•© í† í°: surface/reading í•©ì‚°, level/korean/posëŠ” ì²« í† í° ê¸°ì¤€,
   * _mergedIndices: ì›ë³¸ ì¸ë±ìŠ¤ ë°°ì—´, _isMerged: true
   */
  function applyMergeGroups(rawTokens, groups) {
    // _origIdxê°€ ì´ë¯¸ ì„¤ì •ëœ ê²½ìš° ë³´ì¡´ (ì»¤ìŠ¤í…€ ìë™ ë³‘í•© í›„ í˜¸ì¶œ ì‹œ)
    const hasOrigIdx = rawTokens.length > 0 && rawTokens[0]._origIdx !== undefined;

    if (!groups || groups.length === 0) {
      if (hasOrigIdx) return rawTokens.map(tk => Object.assign({}, tk));
      return rawTokens.map((tk, i) => Object.assign({}, tk, { _origIdx: i }));
    }

    // ìˆ˜ë™ ë³‘í•© ê·¸ë£¹ì€ rawTokensì˜ _origIdx ê¸°ì¤€ìœ¼ë¡œ ë§¤í•‘
    // _origIdxê°€ ì—†ìœ¼ë©´ ë°°ì—´ ìˆœì„œ(i)ë¥¼ ì‚¬ìš©
    const getIdx = (tk, i) => hasOrigIdx ? tk._origIdx : i;

    // origIdx â†’ ë°°ì—´ ìœ„ì¹˜ ì—­ì¸ë±ìŠ¤
    const origIdxMap = {};
    rawTokens.forEach((tk, ii) => { origIdxMap[getIdx(tk, ii)] = ii; });

    // ì–´ë–¤ origIdxê°€ ì–´ëŠ ê·¸ë£¹ì— ì†í•˜ëŠ”ì§€ ë§µ êµ¬ì„±
    const idxToGroup = {};
    groups.forEach((g, gi) => g.forEach(idx => { idxToGroup[idx] = gi; }));

    const result = [];
    const consumed = new Set();

    for (let i = 0; i < rawTokens.length; i++) {
      const origIdx = getIdx(rawTokens[i], i);
      if (consumed.has(origIdx)) continue;
      const gi = idxToGroup[origIdx];
      if (gi !== undefined) {
        // ì´ ê·¸ë£¹ì˜ ì²« ë²ˆì§¸ ì¸ë±ìŠ¤ì¸ì§€ í™•ì¸
        const group = groups[gi];
        if (group[0] !== origIdx) continue; // ì²« ë²ˆì§¸ë§Œ ì²˜ë¦¬

        // ê·¸ë£¹ ë‚´ origIdxì— í•´ë‹¹í•˜ëŠ” rawTokens í•­ëª© ìˆ˜ì§‘
        const memberTks = group
          .map(gIdx => rawTokens[origIdxMap[gIdx]])
          .filter(Boolean);
        memberTks.forEach(tk => consumed.add(getIdx(tk, 0)));

        const first = memberTks[0];
        const mergedSurface = memberTks.map(tk => tk.surface).join('');
        const mergedReading = memberTks.map(tk => tk.reading).join('');

        // ì‚¬ì „ ì¬ê²€ìƒ‰ (ë³‘í•©ëœ í‘œì¸µí˜•)
        const mergedInfo = lookupWord(mergedSurface, mergedSurface, mergedReading);
        let mergedLevel, mergedKorean;
        if (GRAMMAR_POS.includes(first.pos)) {
          mergedLevel = 'æ–‡æ³•'; mergedKorean = '-';
        } else if (mergedInfo) {
          mergedLevel = mergedInfo.l; mergedKorean = mergedInfo.k;
        } else {
          // ì²« ë²ˆì§¸ í† í°ì˜ ë ˆë²¨ ì‚¬ìš©
          mergedLevel = first.level; mergedKorean = first.korean;
        }

        result.push(Object.assign({}, first, {
          surface:       mergedSurface,
          reading:       mergedReading,
          level:         mergedLevel,
          korean:        mergedKorean,
          _origIdx:      group[0],
          _mergedIndices: group,
          _isMerged:     true
        }));
      } else {
        consumed.add(origIdx);
        result.push(Object.assign({}, rawTokens[i], { _origIdx: hasOrigIdx ? origIdx : i }));
      }
    }
    return result;
  }

  /** ë³‘í•© ê·œì¹™ ì „ì²´ ì´ˆê¸°í™” */
  function resetMergeRules() {
    if (!confirm('ì €ì¥ëœ ë³‘í•© ê·œì¹™ì„ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
    localStorage.removeItem(MERGE_RULES_KEY);
    location.reload();
  }

  /**
   * KR_EDITS ì €ì¥ í˜•ì‹: { baseForm: { k: "í•œêµ­ì–´ëœ»", d: "YYYY-MM-DD" } }
   * êµ¬ë²„ì „ í˜¸í™˜: ê°’ì´ ë¬¸ìì—´ì´ë©´ { k: ê°’, d: '-' } ë¡œ ìë™ ë³€í™˜
   */
  function loadKrEdits() {
    try {
      const raw = JSON.parse(localStorage.getItem(KR_EDITS_KEY) || '{}');
      // êµ¬ë²„ì „(string ê°’) ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜
      const result = {};
      for (const [k, v] of Object.entries(raw)) {
        result[k] = (typeof v === 'string') ? { k: v, d: '-' } : v;
      }
      return result;
    } catch(e) { return {}; }
  }

  const krEditsStore = createStore(KR_EDITS_KEY, {});
  /** { baseForm: { k, d } } í˜•íƒœ ê·¸ëŒ€ë¡œ ì €ì¥ */
  function saveKrEdits(edits) { krEditsStore.save(edits); }

  /** í•œêµ­ì–´ ëœ» ë¬¸ìì—´ë§Œ ì¶”ì¶œí•˜ëŠ” í—¬í¼ */
  function getKrEditValue(entry) {
    if (!entry) return undefined;
    return (typeof entry === 'string') ? entry : entry.k;
  }

  function updateKrEdit(baseForm, newKorean) {
    const edits = loadKrEdits();
    const today = new Date().toISOString().slice(0, 10);
    if (newKorean && newKorean !== '-') {
      edits[baseForm] = { k: newKorean, d: today };
    } else {
      delete edits[baseForm];
    }
    saveKrEdits(edits);
    touchDictUpdated();  // ì‚¬ì „ ê°±ì‹ ì¼ ê¸°ë¡
    // JLPT_DICTì—ë„ ì¦‰ì‹œ ë°˜ì˜ (ì¹´íƒ€ì¹´ë‚˜Â·íˆë¼ê°€ë‚˜ í‚¤ë„ ë™ì‹œ ì—…ë°ì´íŠ¸)
    for (const key of Object.keys(JLPT_DICT)) {
      if (JLPT_DICT[key].r === baseForm || key === baseForm) {
        JLPT_DICT[key].k = newKorean || '-';
      }
    }
  }

  function resetKrEdits() {
    if (!confirm('ì €ì¥ëœ í•œêµ­ì–´ ëœ» ìˆ˜ì • ë‚´ì—­ì„ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
    localStorage.removeItem(KR_EDITS_KEY);
    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì›ë³¸ ì‚¬ì „ ë³µì›
    location.reload();
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ í¸ì§‘ ë‚´ì—­ì„ JLPT_DICTì— ë®ì–´ì”Œì›€
  function applyStoredEdits() {
    const edits = loadKrEdits();
    for (const [baseForm, entry] of Object.entries(edits)) {
      const korean = getKrEditValue(entry);
      for (const key of Object.keys(JLPT_DICT)) {
        if (JLPT_DICT[key].r === baseForm || key === baseForm) {
          JLPT_DICT[key].k = korean;
        }
      }
    }
  }

  function isEdited(baseForm) {
    const edits = loadKrEdits();
    return Object.prototype.hasOwnProperty.call(edits, baseForm);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ì»¤ìŠ¤í…€ ë‹¨ì–´ â€” localStorage ëª¨ë“ˆ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ì €ì¥ í˜•ì‹: [ {surface, reading, level, pos, korean}, ... ]

  const customWordsStore = createStore(CUSTOM_WORDS_KEY, []);
  function loadCustomWords() { return customWordsStore.load(); }
  function saveCustomWords(words) { customWordsStore.save(words); }

  /** ì €ì¥ëœ ì»¤ìŠ¤í…€ ë‹¨ì–´ë¥¼ JLPT_DICTì— ì¦‰ì‹œ ë°˜ì˜ */
  function applyCustomWords() {
    const words = loadCustomWords();
    words.forEach(w => {
      const entry = { r: w.reading, l: w.level, k: w.korean || '-' };
      // surface í‚¤ ë“±ë¡
      JLPT_DICT[w.surface] = entry;
      // reading í‚¤ë„ ë“±ë¡ (íˆë¼ê°€ë‚˜)
      if (w.reading && w.reading !== w.surface) {
        JLPT_DICT[w.reading] = entry;
      }
    });
  }

  /** ì»¤ìŠ¤í…€ ë‹¨ì–´ ì¶”ê°€ (ì¤‘ë³µ surfaceëŠ” ë®ì–´ì”€, ë‚ ì§œ ìë™ ê¸°ë¡) */
  function addCustomWord(word) {
    const today = new Date().toISOString().slice(0, 10);
    const words = loadCustomWords();
    const idx = words.findIndex(w => w.surface === word.surface);
    const wordWithDate = Object.assign({}, word, { d: word.d || today });
    if (idx >= 0) {
      words[idx] = wordWithDate;
    } else {
      words.push(wordWithDate);
    }
    saveCustomWords(words);
    touchDictUpdated();  // ì‚¬ì „ ê°±ì‹ ì¼ ê¸°ë¡
    // JLPT_DICT ì¦‰ì‹œ ë°˜ì˜
    const entry = { r: word.reading, l: word.level, k: word.korean || '-' };
    JLPT_DICT[word.surface] = entry;
    if (word.reading && word.reading !== word.surface) {
      JLPT_DICT[word.reading] = entry;
    }
  }

  /** ì»¤ìŠ¤í…€ ë‹¨ì–´ ì‚­ì œ */
  function deleteCustomWord(surface) {
    const words = loadCustomWords().filter(w => w.surface !== surface);
    saveCustomWords(words);
    touchDictUpdated();  // ì‚­ì œë„ ì‚¬ì „ ê°±ì‹ ìœ¼ë¡œ ê¸°ë¡
    // JLPT_DICTì—ì„œë„ ì œê±°
    delete JLPT_DICT[surface];
    // reading í‚¤ëŠ” ë‹¤ë¥¸ ë‹¨ì–´ì™€ ê³µìœ í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë‚¨ê²¨ë‘ 
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ë‹¨ì–´ ì¶”ê°€ ëª¨ë‹¬ í•¸ë“¤ëŸ¬
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function openWordAddModal() {
    // ì…ë ¥ ì´ˆê¸°í™”
    document.getElementById('wa-surface').value  = '';
    document.getElementById('wa-reading').value  = '';
    document.getElementById('wa-level').value    = 'N3';
    document.getElementById('wa-pos').value      = 'åè©';
    document.getElementById('wa-korean').value   = '';
    document.getElementById('wordAddError').textContent = '';

    renderCustomWordsList();

    const modal = document.getElementById('wordAddModal');
    modal.classList.add('visible');
    setTimeout(() => document.getElementById('wa-surface').focus(), 80);
  }

  function closeWordAddModal() {
    document.getElementById('wordAddModal').classList.remove('visible');
  }

  function saveCustomWord() {
    const surface = document.getElementById('wa-surface').value.trim();
    const reading = document.getElementById('wa-reading').value.trim();
    const level   = document.getElementById('wa-level').value;
    const pos     = document.getElementById('wa-pos').value;
    const korean  = document.getElementById('wa-korean').value.trim();
    const errEl   = document.getElementById('wordAddError');

    // ìœ íš¨ì„± ê²€ì‚¬
    if (!surface) {
      errEl.textContent = 'í‘œì¸µí˜•ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      document.getElementById('wa-surface').focus();
      return;
    }
    if (!reading) {
      errEl.textContent = 'ì½ê¸°(íˆë¼ê°€ë‚˜)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      document.getElementById('wa-reading').focus();
      return;
    }
    errEl.textContent = '';

    addCustomWord({ surface, reading, level, pos, korean });

    // í˜„ì¬ ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¬ë¶„ì„í•˜ì—¬ ìƒˆ ë‹¨ì–´ ë°˜ì˜
    if (lastResult) {
      const text = lastResult.input;
      document.getElementById('inputText').value = text;
      analyze();
    }

    // ì„±ê³µ ë©”ì‹œì§€ (1.8ì´ˆ í›„ ìë™ ì†Œë©¸)
    errEl.style.color = '#00e676';
    errEl.textContent = `âœ“  "${surface}" ì¶”ê°€ë¨`;
    setTimeout(() => { errEl.style.color = ''; errEl.textContent = ''; }, 1800);

    // ì…ë ¥ ì´ˆê¸°í™” í›„ ë‹¤ìŒ ë‹¨ì–´ ì…ë ¥ ëŒ€ê¸°
    document.getElementById('wa-surface').value = '';
    document.getElementById('wa-reading').value = '';
    document.getElementById('wa-korean').value  = '';
    document.getElementById('wa-surface').focus();

    renderCustomWordsList();
  }

  function deleteCustomWordAndRefresh(surface) {
    deleteCustomWord(surface);
    renderCustomWordsList();
    // í˜„ì¬ ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¬ë¶„ì„í•˜ì—¬ ì‚­ì œ ë°˜ì˜
    if (lastResult) {
      const text = lastResult.input;
      document.getElementById('inputText').value = text;
      analyze();
    }
  }

  function renderCustomWordsList() {
    const words  = loadCustomWords();
    const listEl = document.getElementById('customWordsList');
    const countEl = document.getElementById('customWordsCount');
    if (!listEl) return;

    countEl.textContent = words.length;

    if (words.length === 0) {
      listEl.innerHTML = '<div class="custom-words-empty">ë“±ë¡ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }

    listEl.innerHTML = words.map(w => {
      const color = LEVEL_COLOR[w.level] || LEVEL_COLOR['å¤–'];
      return `
        <div class="custom-word-row">
          <span class="custom-word-surface">${escHtml(w.surface)}</span>
          <span class="custom-word-reading">${escHtml(w.reading)}</span>
          <span class="custom-word-lv" style="background:${color}22;color:${color};border:1px solid ${color}55;">${escHtml(w.level)}</span>
          <span class="custom-word-kr">${escHtml(w.korean || '-')}</span>
          <button class="btn-custom-word-del" title="ì‚­ì œ"
                  data-surface="${escHtml(w.surface)}">âœ•</button>
        </div>`;
    }).join('');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ì¸ë¼ì¸ í¸ì§‘ í•¨ìˆ˜
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // í† í° ì¹´ë“œìš© (mode='token') ë˜ëŠ” ë‹¨ì–´ ì¹´ë“œìš© (mode='word')
  function startKrEdit(el) {
    const mode = el.dataset.mode || 'token';
    const original = el.dataset.original;
    const baseForm = el.dataset.baseForm;
    const inputClass = mode === 'word' ? 'word-kr-edit-input' : 'kr-edit-input';

    const input = document.createElement('input');
    input.type = 'text';
    input.className = inputClass;
    input.value = (original === '-') ? '' : original;
    input.dataset.baseForm = baseForm;
    input.dataset.original = original;
    input.dataset.mode = mode;

    el.replaceWith(input);
    input.focus();
    input.select();

    input.addEventListener('keydown', e => {
      if (e.key === 'Enter')  { e.preventDefault(); commitKrEdit(input); }
      if (e.key === 'Escape') { e.preventDefault(); cancelKrEdit(input); }
    });
    let blurTimer = null;
    input.addEventListener('blur', () => {
      blurTimer = setTimeout(() => commitKrEdit(input), 120);
    });
    input._clearBlurTimer = () => clearTimeout(blurTimer);
  }

  function startKrEditFromBtn(btn) {
    const baseForm = btn.dataset.baseForm;
    const mode = btn.dataset.mode || 'token';
    const inputClass = mode === 'word' ? 'word-kr-edit-input' : 'kr-edit-input';

    const input = document.createElement('input');
    input.type = 'text';
    input.className = inputClass;
    input.value = '';
    input.dataset.baseForm = baseForm;
    input.dataset.original = '-';
    input.dataset.mode = mode;
    input.dataset.fromBtn = 'true';

    btn.replaceWith(input);
    input.focus();

    input.addEventListener('keydown', e => {
      if (e.key === 'Enter')  { e.preventDefault(); commitKrEdit(input); }
      if (e.key === 'Escape') { e.preventDefault(); cancelKrEdit(input); }
    });
    let blurTimer = null;
    input.addEventListener('blur', () => {
      blurTimer = setTimeout(() => commitKrEdit(input), 120);
    });
    input._clearBlurTimer = () => clearTimeout(blurTimer);
  }

  function commitKrEdit(input) {
    if (input._committed) return;  // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
    input._committed = true;
    if (input._clearBlurTimer) input._clearBlurTimer();
    const newKorean = input.value.trim();
    const baseForm  = input.dataset.baseForm;
    const original  = input.dataset.original;
    const mode      = input.dataset.mode || 'token';
    const fromBtn   = input.dataset.fromBtn === 'true';

    if (newKorean !== original) {
      // ë¹ˆ ë¬¸ìì—´ ì €ì¥ ì‹œ updateKrEdit ë‚´ë¶€ì—ì„œ delete ì²˜ë¦¬ë¨
      updateKrEdit(baseForm, newKorean);
      // lastResult ì˜ í•´ë‹¹ í† í°ë„ ì¦‰ì‹œ ê°±ì‹ 
      if (lastResult) {
        lastResult.tokens.forEach(t => {
          if (t.baseForm === baseForm) t.korean = newKorean || '-';
        });
      }
    }

    // í™”ë©´ì— í‘œì‹œí•  ìµœì¢… í…ìŠ¤íŠ¸: ìƒˆ ê°’ì´ ìˆìœ¼ë©´ ìƒˆ ê°’, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ (ë²„íŠ¼ í‘œì‹œë¡œ ë¶„ê¸°)
    const finalText = newKorean || '';
    const edited    = isEdited(baseForm) || (newKorean && newKorean !== original);

    if (finalText && finalText !== '-') {
      // ëœ» span ë³µì›
      const span = document.createElement(mode === 'word' ? 'div' : 'span');
      span.className = (mode === 'word' ? 'word-kr' : 'token-kr') + (edited ? ' edited' : '');
      span.textContent = finalText;
      span.dataset.baseForm = baseForm;
      span.dataset.original = finalText;
      span.dataset.mode = mode;
      input.replaceWith(span);
    } else {
      // ëœ» ì—†ìŒ â†’ ë²„íŠ¼ ë³µì›
      const btn = document.createElement('button');
      btn.className = mode === 'word' ? 'btn-add-word-kr' : 'btn-add-kr';
      btn.textContent = mode === 'word' ? '+ ëœ» ì¶”ê°€' : '+ëœ»';
      btn.dataset.baseForm = baseForm;
      btn.dataset.mode = mode;
      input.replaceWith(btn);
    }
  }

  function cancelKrEdit(input) {
    if (input._committed) return;  // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
    input._committed = true;
    if (input._clearBlurTimer) input._clearBlurTimer();
    const original = input.dataset.original;
    const baseForm = input.dataset.baseForm;
    const mode     = input.dataset.mode || 'token';
    const fromBtn  = input.dataset.fromBtn === 'true';
    const edited   = isEdited(baseForm);

    if (fromBtn || !original || original === '-') {
      const btn = document.createElement('button');
      btn.className = mode === 'word' ? 'btn-add-word-kr' : 'btn-add-kr';
      btn.textContent = mode === 'word' ? '+ ëœ» ì¶”ê°€' : '+ëœ»';
      btn.dataset.baseForm = baseForm;
      btn.dataset.mode = mode;
      input.replaceWith(btn);
    } else {
      const span = document.createElement(mode === 'word' ? 'div' : 'span');
      span.className = (mode === 'word' ? 'word-kr' : 'token-kr') + (edited ? ' edited' : '');
      span.textContent = original;
      span.dataset.baseForm = baseForm;
      span.dataset.original = original;
      span.dataset.mode = mode;
      input.replaceWith(span);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ë ˆë²¨ë³„ ìƒ‰ìƒ ë§µ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // í…Œë§ˆ (ë¼ì´íŠ¸ / ë‹¤í¬)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const THEME_KEY         = 'tangoya_theme';
  const THEME_VERSION_KEY = 'tangoya_theme_ver';
  const THEME_VERSION     = '2';   // ë¼ì´íŠ¸ ëª¨ë“œ ê¸°ë³¸ìœ¼ë¡œ ì „í™˜í•œ ë²„ì „

  // ì´ì „ ë²„ì „ ê¸°ë¡ì´ ì—†ìœ¼ë©´ í…Œë§ˆë¥¼ lightë¡œ ì´ˆê¸°í™” (ìµœì´ˆ ë°©ë¬¸ ë˜ëŠ” ë²„ì „ ì—…)
  (function migrateTheme() {
    if (localStorage.getItem(THEME_VERSION_KEY) !== THEME_VERSION) {
      localStorage.setItem(THEME_KEY, 'light');
      localStorage.setItem(THEME_VERSION_KEY, THEME_VERSION);
    }
  })();

  function applyTheme(theme) {
    if (theme === 'light') {
      document.body.classList.add('light-mode');
      const btn = document.getElementById('themeBtn');
      if (btn) btn.textContent = 'ğŸŒ™';   // ë¼ì´íŠ¸ ëª¨ë“œ ì¤‘ â†’ ë²„íŠ¼ ëˆ„ë¥´ë©´ ë‹¤í¬ë¡œ
    } else {
      document.body.classList.remove('light-mode');
      const btn = document.getElementById('themeBtn');
      if (btn) btn.textContent = 'â˜€ï¸';   // ë‹¤í¬ ëª¨ë“œ ì¤‘ â†’ ë²„íŠ¼ ëˆ„ë¥´ë©´ ë¼ì´íŠ¸ë¡œ
    }
    localStorage.setItem(THEME_KEY, theme);
    // LEVEL_COLORë„ í…Œë§ˆì— ë”°ë¼ ê°±ì‹ 
    updateLevelColors();
  }

  function toggleTheme() {
    const isLight = document.body.classList.contains('light-mode');
    applyTheme(isLight ? 'dark' : 'light');
  }

  function updateLevelColors() {
    const scheme = COLOR_SCHEMES[document.body.classList.contains('light-mode') ? 'light' : 'dark'];
    Object.assign(LEVEL_COLOR, scheme);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ê´€ë¦¬ì ëª¨ë“œ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const ADMIN_PW   = '4649';
  let   isAdminMode = false;

  function openAdminModal() {
    if (isAdminMode) {
      // ì´ë¯¸ ê´€ë¦¬ì â†’ ë¡œê·¸ì•„ì›ƒ
      exitAdminMode();
      return;
    }
    const modal = document.getElementById('adminModal');
    const input = document.getElementById('adminPwInput');
    const err   = document.getElementById('adminPwError');
    const icon  = document.getElementById('adminModalIcon');
    const title = document.getElementById('adminModalTitle');
    icon.textContent  = 'ğŸ”';
    title.textContent = 'ê´€ë¦¬ì ëª¨ë“œ';
    err.textContent   = '';
    input.value = '';
    input.classList.remove('error');
    modal.classList.add('visible');
    setTimeout(() => input.focus(), CONFIG.ADMIN_MODAL_FOCUS_MS);
  }

  function closeAdminModal() {
    document.getElementById('adminModal').classList.remove('visible');
    document.getElementById('adminPwInput').value = '';
    document.getElementById('adminPwError').textContent = '';
    document.getElementById('adminPwInput').classList.remove('error');
  }

  function confirmAdmin() {
    const input = document.getElementById('adminPwInput');
    const err   = document.getElementById('adminPwError');
    if (input.value === ADMIN_PW) {
      closeAdminModal();
      enterAdminMode();
    } else {
      err.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤';
      input.classList.add('error');
      input.value = '';
      setTimeout(() => {
        input.classList.remove('error');
        err.textContent = '';
      }, CONFIG.ADMIN_ERROR_CLEAR_MS);
      setTimeout(() => input.focus(), CONFIG.LANG_MODAL_FOCUS_MS);
    }
  }

  function enterAdminMode() {
    isAdminMode = true;
    document.body.classList.add('admin-mode');
    const btn = document.getElementById('adminBtn');
    if (btn) { btn.textContent = 'ğŸ”“'; btn.classList.add('admin-active'); btn.title = 'ê´€ë¦¬ì ëª¨ë“œ ì¢…ë£Œ'; }
    // í˜„ì¬ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ ë Œë”ë§
    if (lastResult) showResult(lastResult.tokens, lastResult.input);
  }

  function exitAdminMode() {
    isAdminMode = false;
    document.body.classList.remove('admin-mode');
    const btn = document.getElementById('adminBtn');
    if (btn) { btn.textContent = 'ğŸ”’'; btn.classList.remove('admin-active'); btn.title = 'ê´€ë¦¬ì ëª¨ë“œ'; }
    if (lastResult) showResult(lastResult.tokens, lastResult.input);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ê´€ë¦¬ì í¸ì§‘: í† í° í•„ë“œ ì¸ë¼ì¸ ìˆ˜ì •
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const ADMIN_EDITS_KEY = 'tangoya_admin_edits';
  // ì €ì¥ í˜•ì‹: { "surface@@origIdx@@inputText": {reading, level, pos, surface} }

  const adminEditsStore = createStore(ADMIN_EDITS_KEY, {});
  function loadAdminEdits() { return adminEditsStore.load(); }

  function saveAdminEdit(inputText, origIdx, field, value) {
    const edits = loadAdminEdits();
    const key   = origIdx + '@@' + inputText;
    if (!edits[key]) edits[key] = {};
    edits[key][field] = value;
    adminEditsStore.save(edits);
  }

  function getAdminEdit(inputText, origIdx) {
    const edits = loadAdminEdits();
    return edits[origIdx + '@@' + inputText] || {};
  }

  /** ë¶„ì„ í›„ ê´€ë¦¬ì í¸ì§‘ ë‚´ì—­ì„ í† í° ë°°ì—´ì— ì ìš© */
  function applyAdminEdits(tokens, inputText) {
    const edits = loadAdminEdits();
    return tokens.map(tk => {
      const key  = tk._origIdx + '@@' + inputText;
      const edit = edits[key];
      if (!edit) return tk;
      return Object.assign({}, tk, {
        reading:  edit.reading  !== undefined ? edit.reading  : tk.reading,
        level:    edit.level    !== undefined ? edit.level    : tk.level,
        pos:      edit.pos      !== undefined ? edit.pos      : tk.pos,
        surface:  edit.surface  !== undefined ? edit.surface  : tk.surface,
        baseForm: edit.baseForm !== undefined ? edit.baseForm : tk.baseForm,
      });
    });
  }

  function resetAdminEdits() {
    if (!confirm('ì €ì¥ëœ ê´€ë¦¬ì í¸ì§‘ ë‚´ì—­ì„ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
    localStorage.removeItem(ADMIN_EDITS_KEY);
    location.reload();
  }

  const LEVEL_COLOR = {
    N1: '#ff4d6d', N2: '#ff8800', N3: '#ffd600',
    N4: '#00e676', N5: '#40c4ff',
    'å¤–': '#6060a0', 'æ–‡æ³•': '#444466'
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Enter í‚¤ ë°”ì¸ë”© (Shift+Enter ì œì™¸)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  document.addEventListener('DOMContentLoaded', () => {
    // ì €ì¥ëœ í…Œë§ˆ ë³µì› (ì—†ìœ¼ë©´ ë¼ì´íŠ¸ ëª¨ë“œ ê¸°ë³¸)
    const savedTheme = localStorage.getItem(THEME_KEY);
    applyTheme(savedTheme || 'light');
    // í‘¸í„° ì‚¬ì „ ê°±ì‹ ì¼ í‘œì‹œ
    const footerEl = document.getElementById('footerDictUpdated');
    if (footerEl) footerEl.textContent = getDictUpdated();

    // ê´€ë¦¬ì í¸ì§‘ ì´ë²¤íŠ¸ ìœ„ì„
    // â‘  select ë³€ê²½ â†’ ì¦‰ì‹œ ì €ì¥
    document.addEventListener('change', e => {
      const el = e.target;
      if (!isAdminMode) return;
      if (el.classList.contains('admin-select') && el.dataset.field) {
        adminSaveField(el);
      }
    });

    // â‘¡ input: Enter â†’ ì €ì¥, Escape â†’ ì·¨ì†Œ
    document.addEventListener('keydown', e => {
      const el = e.target;
      if (!isAdminMode) return;
      if (el.classList.contains('admin-input') && el.dataset.field) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adminSaveField(el);
          el.blur();
          el.style.borderColor = '#00e676';
          setTimeout(() => { el.style.borderColor = ''; }, CONFIG.ADMIN_SAVED_FLASH_MS);
        }
        if (e.key === 'Escape') { el.blur(); }
      }
    });

    // â‘¢ input: í¬ì»¤ìŠ¤ ì´íƒˆ â†’ ì €ì¥ (capture)
    document.addEventListener('blur', e => {
      const el = e.target;
      if (!isAdminMode) return;
      if (el.classList.contains('admin-input') && el.dataset.field) {
        adminSaveField(el);
      }
    }, true);

    // â‘£ í´ë¦­ ìœ„ì„: token-kr / word-kr â†’ í•œêµ­ì–´ ëœ» í¸ì§‘
    //              btn-add-kr / btn-add-word-kr â†’ ëœ» ì¶”ê°€
    document.addEventListener('click', e => {
      if (!isAdminMode) return;
      const el = e.target;

      // í•œêµ­ì–´ ëœ» span í´ë¦­
      if (el.classList.contains('token-kr') || el.classList.contains('word-kr')) {
        e.stopPropagation();
        startKrEdit(el);
        return;
      }

      // +ëœ» / + ëœ» ì¶”ê°€ ë²„íŠ¼ í´ë¦­
      if (el.classList.contains('btn-add-kr') || el.classList.contains('btn-add-word-kr')) {
        e.stopPropagation();
        startKrEditFromBtn(el);
        return;
      }

      // ì»¤ìŠ¤í…€ ë‹¨ì–´ ì‚­ì œ ë²„íŠ¼
      if (el.classList.contains('btn-custom-word-del')) {
        const surface = el.dataset.surface;
        if (surface && confirm(`"${surface}" ë¥¼ ì‚­ì œí• ê¹Œìš”?`)) {
          deleteCustomWordAndRefresh(surface);
        }
        return;
      }
    });
    const ta = document.getElementById('inputText');
    if (ta) {
      ta.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          analyze();
        }
      });
    }

    // â”€â”€ ì„œë²„ ìƒì¡´ ì‹ í˜¸ (íƒ­ ë‹«íˆë©´ ì„œë²„ ìë™ ì¢…ë£Œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // HTTP ì„œë²„ë¡œ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°ì—ë§Œ í™œì„±í™”
    if (location.protocol !== 'file:') {
      setInterval(() => {
        fetch('/ping').catch(() => {});
      }, CONFIG.SERVER_PING_INTERVAL_MS);
    }
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // processTokens(text) â€” í˜•íƒœì†Œ ë¶„ì„ â†’ í›„ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸
  // analyze() ë¡œë¶€í„° ë¶„ë¦¬ëœ ìˆœìˆ˜ ë°ì´í„° ë³€í™˜ í•¨ìˆ˜
  // ë°˜í™˜: { rawTokens, tokens }
  //   rawTokens: ì»¤ìŠ¤í…€ ìë™ ë³‘í•© í›„ í† í° (ìˆ˜ë™ ë³‘í•© ê¸°ì¤€ ì›ë³¸)
  //   tokens:    ìµœì¢… í¸ì§‘ ì ìš© í† í° (í‘œì‹œ/ë‹¤ìš´ë¡œë“œìš©)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function processTokens(text) {
    // â‘  í˜•íƒœì†Œ ë¶„ì„
    const kuroTokens = tokenizer.tokenize(text);

    // â‘¡ ê° í† í° ê°€ê³µ (Kuromoji ì›ì‹œ í† í° â†’ ì•± í† í° ê°ì²´)
    const tokens = kuroTokens.map(t => {
      const surface     = t.surface_form;
      const baseForm    = (t.basic_form && t.basic_form !== '*') ? t.basic_form : surface;
      const readingKata = (t.reading && t.reading !== '*') ? t.reading : surface;
      const readingHira = toHiragana(readingKata);
      const pos         = (t.pos && t.pos !== '*') ? t.pos : 'ä¸æ˜';
      const posDetail   = (t.pos_detail_1 && t.pos_detail_1 !== '*') ? t.pos_detail_1 : '';

      // â‘¢ ì‚¬ì „ ê²€ìƒ‰ + ë ˆë²¨/í•œêµ­ì–´ ê²°ì •
      const info = lookupWord(surface, baseForm, readingHira);
      let level, korean;
      if (GRAMMAR_POS.includes(pos)) {
        level = 'æ–‡æ³•'; korean = '-';
      } else if (info) {
        level = info.l; korean = info.k;
      } else {
        level = 'å¤–'; korean = '-';
      }
      return { surface, baseForm, reading: readingHira, pos, posDetail, level, korean };
    });

    // â‘£ í•œêµ­ì–´ í¸ì§‘ ë‚´ì—­ ì ìš©
    const krEdits = loadKrEdits();
    tokens.forEach(tk => {
      const entry = krEdits[tk.baseForm];
      if (entry !== undefined) tk.korean = getKrEditValue(entry);
    });

    // â‘¤ ì»¤ìŠ¤í…€ ë‹¨ì–´ ìë™ ë³‘í•© (greedy longest match)
    const customWords = loadCustomWords();
    const customMap = {};
    customWords.forEach(w => { customMap[w.surface] = w; });

    const rawTokens = autoMergeCustomWords(
      tokens.map((tk, i) => Object.assign({}, tk, { _origIdx: i })),
      customMap
    );
    // ìë™ ë³‘í•© ì—†ì´ surfaceë§Œ ì¼ì¹˜í•˜ëŠ” ë‹¨ë… í† í°ì˜ pos ë®ì–´ì“°ê¸°
    rawTokens.forEach(tk => {
      const cw = customMap[tk.surface] || customMap[tk.baseForm];
      if (cw && !tk._isCustom) tk.pos = cw.pos;
    });

    // â‘¥ ìˆ˜ë™ ë³‘í•© ê·œì¹™ ì ìš©
    const mergedTokens = applyMergeGroups(rawTokens, getMergeGroups(text));

    // â‘¦ ê´€ë¦¬ì í¸ì§‘ ì ìš©
    const editedTokens = applyAdminEdits(mergedTokens, text);

    // â‘§ ê´€ë¦¬ì í¸ì§‘ í›„ krEdits ì¬ì ìš© (baseForm ë³€ê²½ ëŒ€ë¹„)
    editedTokens.forEach(tk => {
      const entry = krEdits[tk.baseForm];
      if (entry !== undefined) tk.korean = getKrEditValue(entry);
    });

    return { rawTokens, tokens: editedTokens };
  }

  /**
   * ì»¤ìŠ¤í…€ ë‹¨ì–´ ìë™ ë³‘í•© â€” processTokens()ì—ì„œ ì‚¬ìš©
   * customMap: { surface â†’ customWordObj }
   * greedy longest matchë¡œ ì—°ì† í† í° ë³‘í•©
   */
  function autoMergeCustomWords(tkArr, customMap) {
    const surfaces = Object.keys(customMap).sort((a, b) => b.length - a.length);
    let result = tkArr;
    for (const cSurface of surfaces) {
      const cw = customMap[cSurface];
      let i = 0;
      const next = [];
      while (i < result.length) {
        let matched = false;
        for (let len = result.length - i; len >= 2; len--) {
          const combined = result.slice(i, i + len).map(t => t.surface).join('');
          if (combined === cSurface) {
            const members = result.slice(i, i + len);
            const mergedInfo = JLPT_DICT[cSurface];
            next.push({
              surface:        cSurface,
              baseForm:       cSurface,
              reading:        members.map(t => t.reading).join(''),
              pos:            cw.pos || members[0].pos,
              posDetail:      members[0].posDetail,
              level:          mergedInfo ? mergedInfo.l : (cw.level || 'å¤–'),
              korean:         mergedInfo ? mergedInfo.k : (cw.korean || '-'),
              _origIdx:       members[0]._origIdx,
              _mergedIndices: members.map(t => t._origIdx),
              _isMerged:      true,
              _isCustom:      true
            });
            i += len; matched = true; break;
          }
        }
        if (!matched) { next.push(result[i]); i++; }
      }
      result = next;
    }
    return result;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // analyze()
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function analyze() {
    // 1. ì´ˆê¸°í™” ì‹¤íŒ¨ / tokenizer ë¯¸ì¤€ë¹„ ì²´í¬
    if (initFailed) {
      showError('í˜•íƒœì†Œ ë¶„ì„ê¸° ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”.');
      return;
    }
    if (!tokenizer) {
      showError('ì‚¬ì „ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      return;
    }

    // 2. ì…ë ¥ê°’ ê²€ì¦
    const text = (document.getElementById('inputText').value || '').trim();
    if (!text) {
      showError('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    // ì–¸ì–´ ê²€ì¦: ì¼ë³¸ì–´ ë¬¸ìê°€ ì—†ê±°ë‚˜, ë¹„ì¼ë³¸ì–´ ìœ ë‹ˆì½”ë“œ(í•œê¸€Â·ì•„ë ë“±)ê°€ í¬í•¨ë˜ë©´ ê²½ê³ 
    if (!containsJapanese(text) || hasForeignNonJapanese(text)) {
      showLangModal();
      return;
    }

    // 3. UI ì´ˆê¸°í™”
    hideError();
    showLoading(true);
    document.getElementById('resultArea').classList.remove('visible');

    // 4. ë¹„ë™ê¸° ì²˜ë¦¬
    setTimeout(() => {
      try {
        const { rawTokens, tokens: editedTokens } = processTokens(text);

        lastResult = {
          input:      text,
          rawTokens,            // ì»¤ìŠ¤í…€ ìë™ ë³‘í•© ì ìš© í›„ (ìˆ˜ë™ ë³‘í•© ê¸°ì¤€ ì›ë³¸)
          tokens:     editedTokens,
          analyzedAt: new Date().toISOString()
        };
        showResult(editedTokens, text);

      } catch (err) {
        showError('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        console.error(err);
      } finally {
        showLoading(false);
      }
    }, 50);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // showResult(tokens, inputText)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function showResult(tokens, inputText) {
    const content = document.getElementById('resultContent');
    const area    = document.getElementById('resultArea');

    if (tokens.length === 1) {
      // â”â” Case A: ë‹¨ì–´ 1ê°œ â”â”
      const tk = tokens[0];
      const color   = LEVEL_COLOR[tk.level] || LEVEL_COLOR['å¤–'];
      const isListed = (tk.level !== 'å¤–' && tk.level !== 'æ–‡æ³•');

      const LEVELS_ALL_A = ['N5','N4','N3','N2','N1','å¤–','æ–‡æ³•'];
      const POS_LIST_A   = ['åè©','å‹•è©','å½¢å®¹è©','å½¢å®¹å‹•è©','å‰¯è©','åŠ©è©','åŠ©å‹•è©',
                            'æ¥ç¶šè©','æ„Ÿå‹•è©','æ¥é ­è©','æ¥å°¾è¾','è¨˜å·','ä¸æ˜'];

      content.innerHTML = `
        <div class="single-word-card">
          ${isAdminMode
            ? `<input class="admin-input reading-input"
                 style="font-size:18px;max-width:140px;text-align:center;margin-bottom:4px;"
                 value="${escHtml(tk.reading)}"
                 title="ì½ê¸° ìˆ˜ì • (Enterë¡œ ì €ì¥)"
                 data-orig-idx="${tk._origIdx ?? 0}"
                 data-field="reading">`
            : `<div class="word-reading">${escHtml(tk.reading)}</div>`}
          ${isAdminMode
            ? `<input class="admin-input surface-input lg"
                 value="${escHtml(tk.surface)}"
                 title="í•œìí‘œê¸° ìˆ˜ì • (Enterë¡œ ì €ì¥)"
                 data-orig-idx="${tk._origIdx ?? 0}"
                 data-field="surface">`
            : `<div class="word-jp" style="color:${color}">${escHtml(tk.surface)}</div>`}
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:4px 0;">
            ${isAdminMode
              ? `<select class="admin-select lg"
                   title="ë ˆë²¨ ìˆ˜ì •"
                   data-orig-idx="${tk._origIdx ?? 0}"
                   data-field="level">
                   ${LEVELS_ALL_A.map(lv =>
                     `<option value="${lv}"${lv===tk.level?' selected':''}>${lv}</option>`
                   ).join('')}
                 </select>`
              : `<span class="word-level-badge lv-${tk.level}"
                       style="background:${color}22;border:1px solid ${color}55;color:${color}">
                   ${escHtml(tk.level)}
                 </span>`}
            ${isAdminMode
              ? `<select class="admin-select lg"
                   title="í’ˆì‚¬ ìˆ˜ì •"
                   data-orig-idx="${tk._origIdx ?? 0}"
                   data-field="pos">
                   ${POS_LIST_A.map(p =>
                     `<option value="${p}"${p===tk.pos?' selected':''}>${p}</option>`
                   ).join('')}
                 </select>`
              : `<span class="word-level-badge" style="background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-family:'Noto Sans KR',sans-serif;">
                   ${escHtml(tk.pos)}
                 </span>`}
            ${isAdminMode
              ? `<input class="admin-input lg"
                   style="font-family:'Noto Serif JP',serif;color:var(--text);"
                   value="${escHtml(tk.baseForm)}"
                   title="ì‚¬ì „í˜• ìˆ˜ì • (Enterë¡œ ì €ì¥)"
                   data-orig-idx="${tk._origIdx ?? 0}"
                   data-field="baseForm">`
              : `<span class="word-level-badge" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Noto Serif JP',serif;">
                   ${escHtml(tk.baseForm)}
                 </span>`}
          </div>
          ${tk.korean !== '-'
            ? `<div class="word-kr${isEdited(tk.baseForm) ? ' edited' : ''}"
                   data-base-form="${escHtml(tk.baseForm)}"
                   data-original="${escHtml(tk.korean)}"
                   data-mode="word">${escHtml(tk.korean)}</div>`
            : `<button class="btn-add-word-kr"
                       data-base-form="${escHtml(tk.baseForm)}"
                       data-mode="word">+ ëœ» ì¶”ê°€</button>`}
          <div style="font-size:12px;color:var(--muted);margin-top:4px;">
            ${isListed
              ? `JLPT <strong style="color:${color}">${escHtml(tk.level)}</strong> ë“±ì¬ ë‹¨ì–´`
              : 'JLPT ë¯¸ë“±ì¬'}
          </div>
        </div>`;

    } else {
      // â”â” Case B: ë¬¸ì¥ â”â”

      // â‘  ë ˆë²¨ í†µê³„
      const LEVEL_ORDER = ['N5','N4','N3','N2','N1','å¤–','æ–‡æ³•'];
      const countMap = {};
      tokens.forEach(tk => { countMap[tk.level] = (countMap[tk.level]||0) + 1; });

      const statsHtml = LEVEL_ORDER
        .filter(lv => countMap[lv] > 0)
        .map(lv => {
          const c = LEVEL_COLOR[lv] || '#888';
          return `<span style="display:inline-flex;align-items:center;gap:5px;
                    font-size:12px;font-family:'DM Mono',monospace;color:${c};
                    background:${c}18;border:1px solid ${c}44;
                    border-radius:999px;padding:3px 12px;">
                    â— ${escHtml(lv)} ${countMap[lv]}ê°œ
                  </span>`;
        }).join('');

      // â‘¡ í—¤ë”
      const headerHtml = `
        <div style="display:flex;justify-content:space-between;align-items:center;
                    margin-bottom:14px;flex-wrap:wrap;gap:8px;">
          <span style="font-size:13px;font-weight:500;letter-spacing:0.05em;">ë¶„ì„ ê²°ê³¼</span>
          <span style="font-size:12px;color:var(--muted);font-family:'DM Mono',monospace;">
            ${tokens.length} í˜•íƒœì†Œ
          </span>
        </div>`;

      // â‘¢ í† í° ì¹´ë“œ í”Œë¡œìš°
      const LEVELS_ALL = ['N5','N4','N3','N2','N1','å¤–','æ–‡æ³•'];
      const POS_LIST   = ['åè©','å‹•è©','å½¢å®¹è©','å½¢å®¹å‹•è©','å‰¯è©','åŠ©è©','åŠ©å‹•è©',
                          'æ¥ç¶šè©','æ„Ÿå‹•è©','æ¥é ­è©','æ¥å°¾è¾','è¨˜å·','ä¸æ˜'];

      const cardsHtml = tokens.map((tk, cardIdx) => {
        const lc    = LEVEL_COLOR[tk.level] || '#888';
        const isLast = cardIdx === tokens.length - 1;

        // íˆ´íŒ ë‚´ìš©
        const tooltipLines = [
          `í‘œì¸µí˜•ï¼š${escHtml(tk.surface)}`,
          `ì‚¬ì „í˜•ï¼š${escHtml(tk.baseForm)}`,
          `ì½ê¸°ï¼š${escHtml(tk.reading)}`,
          `í’ˆì‚¬ï¼š${escHtml(tk.pos)}${tk.posDetail ? ' Â· ' + escHtml(tk.posDetail) : ''}`,
          `JLPTï¼š${escHtml(tk.level)}`
        ].join('\n');

        // ë³‘í•© ë²„íŠ¼ (ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ í‘œì‹œ)
        const mergeBtn = !isAdminMode ? ''
          : tk._isMerged
            ? `<button class="btn-unmerge" title="ë³‘í•© ì·¨ì†Œ"
                 onclick="event.stopPropagation();doUnmerge(${tk._origIdx})">âœ•</button>`
            : (!isLast
                ? `<button class="btn-merge" title="ë‹¤ìŒ í˜•íƒœì†Œì™€ ë³‘í•©"
                     onclick="event.stopPropagation();doMerge(${tk._origIdx})">+</button>`
                : '');

        // ê´€ë¦¬ì í¸ì§‘ í•„ë“œ (reading / surface / level / pos / baseForm)
        // data-orig-idx + data-field ë¡œ ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹ ì²˜ë¦¬
        const adminReadingField = isAdminMode
          ? `<input class="admin-input reading-input"
               value="${escHtml(tk.reading)}"
               title="ì½ê¸° ìˆ˜ì • (Enterë¡œ ì €ì¥)"
               data-orig-idx="${tk._origIdx}"
               data-field="reading">`
          : `<span class="token-reading">${escHtml(tk.reading)}</span>`;

        const adminSurfaceField = isAdminMode
          ? `<input class="admin-input"
               value="${escHtml(tk.surface)}"
               title="í‘œì¸µí˜• ìˆ˜ì • (Enterë¡œ ì €ì¥)"
               style="font-size:13px;max-width:72px;"
               data-orig-idx="${tk._origIdx}"
               data-field="surface">`
          : `<span class="token-jp">${escHtml(tk.surface)}</span>`;

        const adminLevelField = isAdminMode
          ? `<select class="admin-select"
               title="ë ˆë²¨ ìˆ˜ì •"
               data-orig-idx="${tk._origIdx}"
               data-field="level">
               ${LEVELS_ALL.map(lv =>
                 `<option value="${lv}"${lv===tk.level?' selected':''}>${lv}</option>`
               ).join('')}
             </select>`
          : `<span class="token-lv">${escHtml(tk.level)}</span>`;

        const adminPosField = isAdminMode
          ? `<select class="admin-select"
               title="í’ˆì‚¬ ìˆ˜ì •"
               data-orig-idx="${tk._origIdx}"
               data-field="pos">
               ${POS_LIST.map(p =>
                 `<option value="${p}"${p===tk.pos?' selected':''}>${p}</option>`
               ).join('')}
             </select>`
          : `<span class="token-pos">${escHtml(tk.pos)}</span>`;

        const adminBaseFormField = isAdminMode
          ? `<input class="admin-input"
               style="font-size:10px;max-width:72px;font-family:'Noto Serif JP',serif;"
               value="${escHtml(tk.baseForm)}"
               title="ì‚¬ì „í˜• ìˆ˜ì • (Enterë¡œ ì €ì¥)"
               data-orig-idx="${tk._origIdx}"
               data-field="baseForm">`
          : '';

        return `
          <div class="token-card lv-${tk.level}${tk._isMerged ? ' merged' : ''}"
               title="${isAdminMode ? '' : escHtml(tooltipLines)}"
               style="position:relative;">
            ${mergeBtn}
            ${adminReadingField}
            ${adminSurfaceField}
            ${adminLevelField}
            ${adminPosField}
            ${adminBaseFormField}
            ${tk.korean !== '-'
              ? `<span class="token-kr${isEdited(tk.baseForm) ? ' edited' : ''}"
                       data-base-form="${escHtml(tk.baseForm)}"
                       data-original="${escHtml(tk.korean)}"
                       data-mode="token">${escHtml(tk.korean)}</span>`
              : `<button class="btn-add-kr"
                         data-base-form="${escHtml(tk.baseForm)}"
                         data-mode="token">+ëœ»</button>`}
          </div>`;
      }).join('');

      // â‘£ í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°
      const previewHtml = tokens.map(tk =>
        `${escHtml(tk.surface)}[${escHtml(tk.reading)}, ${escHtml(tk.pos)}, ${escHtml(tk.level)}, ${escHtml(tk.korean)}]`
      ).join(' ');

      content.innerHTML = `
        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:18px;">
          ${statsHtml}
        </div>
        ${headerHtml}
        <div class="token-stream">${cardsHtml}</div>
        <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
          <div style="font-size:10px;font-family:'DM Mono',monospace;color:var(--muted);
                      margin-bottom:6px;letter-spacing:0.06em;">TEXT PREVIEW</div>
          <div style="font-size:11px;color:var(--muted);line-height:1.8;word-break:break-all;">
            ${previewHtml}
          </div>
        </div>`;
    }

    area.classList.add('visible');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ê´€ë¦¬ì í•„ë“œ ì €ì¥
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function adminSaveField(el) {
    if (!isAdminMode || !lastResult) return;
    const origIdx = parseInt(el.dataset.origIdx, 10);
    const field   = el.dataset.field;
    const value   = el.value.trim();
    if (!field || isNaN(origIdx) || value === '') return;

    saveAdminEdit(lastResult.input, origIdx, field, value);
    touchDictUpdated();  // ê´€ë¦¬ì í¸ì§‘ ì‹œ ì‚¬ì „ ê°±ì‹ ì¼ ê¸°ë¡

    // lastResult.tokensì— ì¦‰ì‹œ ë°˜ì˜
    lastResult.tokens = lastResult.tokens.map(tk => {
      if (tk._origIdx === origIdx) {
        return Object.assign({}, tk, { [field]: value });
      }
      return tk;
    });

    // level/pos/surface/baseForm ë³€ê²½ì€ ì „ì²´ ì¬ë Œë” (ìƒ‰ìƒÂ·í´ë˜ìŠ¤Â·í‘œì‹œ ë‚´ìš©ì´ ë°”ë€Œë¯€ë¡œ)
    if (field === 'level' || field === 'pos' || field === 'surface' || field === 'baseForm') {
      showResult(lastResult.tokens, lastResult.input);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // í† í° ë³‘í•© / ì·¨ì†Œ ì•¡ì…˜
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * origIdx ë²ˆì§¸ ì›ë³¸ í† í°ê³¼ origIdx+1 ë²ˆì§¸ë¥¼ ë³‘í•©.
   * ì €ì¥ í›„ í˜„ì¬ ê²°ê³¼ë¥¼ ì¦‰ì‹œ ë‹¤ì‹œ ë Œë”ë§.
   */
  function doMerge(origIdx) {
    if (!isAdminMode || !lastResult) return;
    const raw = lastResult.rawTokens;

    // rawTokensì—ì„œ origIdxì— í•´ë‹¹í•˜ëŠ” í† í°ì˜ ë°°ì—´ ìœ„ì¹˜ë¥¼ ì°¾ì•„ ë‹¤ìŒ í† í°ì˜ _origIdxë¥¼ êµ¬í•¨
    const pos = raw.findIndex(tk => tk._origIdx === origIdx);
    if (pos < 0 || pos >= raw.length - 1) return;
    const nextOrigIdx = raw[pos + 1]._origIdx;

    addMerge(lastResult.input, origIdx, nextOrigIdx);

    const groups       = getMergeGroups(lastResult.input);
    const mergedTokens = applyMergeGroups(raw, groups);
    lastResult.tokens  = mergedTokens;
    showResult(mergedTokens, lastResult.input);
  }

  /**
   * origIdxê°€ ì†í•œ ë³‘í•© ê·¸ë£¹ ì „ì²´ë¥¼ í•´ì œ.
   */
  function doUnmerge(origIdx) {
    if (!isAdminMode || !lastResult) return;
    removeMerge(lastResult.input, origIdx);

    const groups       = getMergeGroups(lastResult.input);
    const mergedTokens = applyMergeGroups(lastResult.rawTokens, groups);
    lastResult.tokens  = mergedTokens;
    showResult(mergedTokens, lastResult.input);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ë¦¬ì…‹
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function resetAll() {
    const ta = document.getElementById('inputText');
    if (ta) { ta.value = ''; ta.focus(); }
    const area = document.getElementById('resultArea');
    if (area) area.classList.remove('visible');
    hideError();
    showLoading(false);
    lastResult = null;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ë‹¤ìš´ë¡œë“œ ê³µí†µ í—¬í¼ (UTF-8 with BOM)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function downloadFile(content, filename, mimeType) {
    const blob = new Blob(['\uFEFF' + content], { type: mimeType + ';charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
  }

  // â”€â”€ downloadJSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function downloadJSON() {
    if (!lastResult) return;
    const data = {
      input:       lastResult.input,
      analyzed_at: lastResult.analyzedAt,
      tokens: lastResult.tokens.map(t => ({
        surface:   t.surface,
        reading:   t.reading,
        base_form: t.baseForm,
        pos:       t.pos,
        level:     t.level,
        korean:    t.korean
      }))
    };
    downloadFile(JSON.stringify(data, null, 2), 'tangoya_result.json', 'application/json');
  }

  // â”€â”€ downloadCSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function downloadCSV() {
    if (!lastResult) return;
    const header = 'ì›ë¬¸,ì½ê¸°,ì‚¬ì „í˜•,í’ˆì‚¬,JLPTë ˆë²¨,í•œêµ­ì–´ëœ»';
    const rows = lastResult.tokens.map(t => {
      const cols = [t.surface, t.reading, t.baseForm, t.pos, t.level, t.korean];
      return cols.map(v => '"' + String(v === undefined ? '' : v).replace(/"/g, '""')
                        + '"').join(',');
    });
    downloadFile(header + '\n' + rows.join('\n'), 'tangoya_result.csv', 'text/csv');
  }

  // â”€â”€ downloadTXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function downloadTXT() {
    if (!lastResult) return;
    const tokenStr = lastResult.tokens
      .map(t => `${t.surface}[${t.reading}, ${t.pos}, ${t.level}, ${t.korean}]`)
      .join(' ');
    const content = 'ì…ë ¥: ' + lastResult.input + '\në¶„ì„: ' + tokenStr;
    downloadFile(content, 'tangoya_result.txt', 'text/plain');
  }

  // â”€â”€ downloadDictCSV (ê´€ë¦¬ì ì „ìš©: ì „ì²´ ì‚¬ì „ CSV) â”€â”€â”€â”€â”€â”€
  function downloadDictCSV() {
    const krEdits     = loadKrEdits();       // { baseForm: korean }
    const customWords = loadCustomWords();   // [ {surface, reading, level, pos, korean} ]

    // â‘  JLPT_DICT ì „ì²´ë¥¼ í–‰ìœ¼ë¡œ ë³€í™˜
    //    íˆë¼ê°€ë‚˜/ê°€íƒ€ì¹´ë‚˜ ì „ìš© í‚¤(í‘œì¸µí˜• = ì½ê¸°)ëŠ” í•œì í‚¤ì™€ ì¤‘ë³µì´ë¯€ë¡œ ìŠ¤í‚µ
    const rows = [];
    const seen = new Set(); // ì¤‘ë³µ ì œê±°ìš© (surface ê¸°ì¤€)

    // ë ˆë²¨ ì •ë ¬ ìˆœì„œ
    const LEVEL_ORDER = { N5:1, N4:2, N3:3, N2:4, N1:5, 'å¤–':6, 'æ–‡æ³•':7 };

    for (const [surface, entry] of Object.entries(JLPT_DICT)) {
      // íˆë¼ê°€ë‚˜Â·ê°€íƒ€ì¹´ë‚˜ ì „ìš© í‚¤ëŠ” ìŠ¤í‚µ (ì´ë¯¸ í•œì í‚¤ë¡œ ë“±ë¡ë˜ì–´ ìˆìŒ)
      if (surface === entry.r) continue;
      if (seen.has(surface)) continue;
      seen.add(surface);

      // krEditsë¡œ í•œêµ­ì–´ëœ» ë®ì–´ì”€ (í˜•ì‹: { k, d } ë˜ëŠ” êµ¬ë²„ì „ string)
      const krEntryS  = krEdits[surface];
      const krEntryR  = krEdits[entry.r];
      const krEntry   = krEntryS !== undefined ? krEntryS : krEntryR;
      const korean    = krEntry !== undefined ? getKrEditValue(krEntry) : entry.k;
      const isKrEdited = krEntry !== undefined;
      const source = isKrEdited ? 'ìˆ˜ì •' : 'ê¸°ë³¸';
      // ìˆ˜ì •ì¼: krEditsì˜ d í•„ë“œ, ì—†ìœ¼ë©´ '-'
      const date   = isKrEdited ? (krEntry.d || '-') : '-';

      rows.push({
        surface,
        reading: entry.r || '',
        level:   entry.l,
        korean:  korean || '-',
        source,
        date,
        _rank:   LEVEL_ORDER[entry.l] ?? 9
      });
    }

    // â‘¡ ì»¤ìŠ¤í…€ ë‹¨ì–´ ì¶”ê°€ (source = 'ì¶”ê°€')
    customWords.forEach(w => {
      if (seen.has(w.surface)) {
        // ê¸°ì¡´ ê¸°ë³¸ ì‚¬ì „ í•­ëª©ì„ ì»¤ìŠ¤í…€ì´ ë®ì–´ì“´ ê²½ìš° â†’ sourceë¥¼ 'ì¶”ê°€'ë¡œ ì—…ë°ì´íŠ¸
        const existing = rows.find(r => r.surface === w.surface);
        if (existing) {
          existing.reading = w.reading;
          existing.level   = w.level;
          existing.korean  = w.korean || '-';
          existing.source  = 'ì¶”ê°€';
          existing.date    = w.d || '-';
          existing._rank   = LEVEL_ORDER[w.level] ?? 9;
        }
        return;
      }
      seen.add(w.surface);
      rows.push({
        surface: w.surface,
        reading: w.reading,
        level:   w.level,
        korean:  w.korean || '-',
        source:  'ì¶”ê°€',
        date:    w.d || '-',
        _rank:   LEVEL_ORDER[w.level] ?? 9
      });
    });

    // â‘¢ ë ˆë²¨ ìˆœ â†’ surface ê°€ë‚˜ë‹¤ ìˆœ ì •ë ¬
    rows.sort((a, b) => {
      if (a._rank !== b._rank) return a._rank - b._rank;
      return a.surface.localeCompare(b.surface, 'ja');
    });

    // â‘£ CSV ìƒì„±
    const q = v => '"' + String(v === undefined || v === null ? '' : v)
                         .replace(/"/g, '""') + '"';

    const header = 'í‘œì¸µí˜•,ì½ê¸°,JLPTë ˆë²¨,í•œêµ­ì–´ëœ»,ì¶œì²˜,ë“±ë¡Â·ìˆ˜ì •ì¼';
    const csvRows = rows.map(r =>
      [r.surface, r.reading, r.level, r.korean, r.source, r.date].map(q).join(',')
    );

    const today = new Date().toISOString().slice(0,10).replace(/-/g,'');
    downloadFile(header + '\n' + csvRows.join('\n'),
                 `tangoya_dict_${today}.csv`, 'text/csv');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ë ˆë²¨ ë¶„ë¥˜ê¸°ì¤€ CSV ì—…ë¡œë“œ ê¸°ëŠ¥
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const CUSTOM_CRITERIA_KEY = 'tangoya_custom_criteria';
  // ì €ì¥ í˜•ì‹: { name: 'ê¸°ì¤€ëª…', entries: [{reading, surface, level}, ...] }

  const criteriaStore = createStore(CUSTOM_CRITERIA_KEY, null);

  /** localStorageì—ì„œ ë¶„ë¥˜ê¸°ì¤€ ë¡œë“œ */
  function loadCriteria() { return criteriaStore.load(); }

  /** ë¶„ë¥˜ê¸°ì¤€ì„ localStorageì— ì €ì¥ */
  function saveCriteria(data) { criteriaStore.save(data); }

  /**
   * ì €ì¥ëœ ë¶„ë¥˜ê¸°ì¤€ì„ JLPT_DICTì— ì¦‰ì‹œ ë°˜ì˜.
   * entries ê° í•­ëª©ì˜ levelë¡œ í•´ë‹¹ surface / reading í‚¤ë¥¼ ë®ì–´ì”€.
   */
  function applyCriteriaToDict(entries) {
    entries.forEach(e => {
      const lv = e.level.trim();
      if (!lv) return;
      // surface í‚¤ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ entry ìœ ì§€, levelë§Œ ë³€ê²½)
      if (e.surface && JLPT_DICT[e.surface]) {
        JLPT_DICT[e.surface] = Object.assign({}, JLPT_DICT[e.surface], { l: lv });
      } else if (e.surface) {
        JLPT_DICT[e.surface] = { r: e.reading || e.surface, l: lv, k: '-' };
      }
      // reading í‚¤ë„ ë™ê¸°í™”
      if (e.reading && e.reading !== e.surface) {
        if (JLPT_DICT[e.reading]) {
          JLPT_DICT[e.reading] = Object.assign({}, JLPT_DICT[e.reading], { l: lv });
        } else {
          JLPT_DICT[e.reading] = { r: e.reading, l: lv, k: '-' };
        }
      }
    });
  }

  /**
   * í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë¶„ë¥˜ê¸°ì¤€ì„ ìë™ ë°˜ì˜í•˜ê³  UI ì—…ë°ì´íŠ¸.
   */
  function applyStoredCriteria() {
    const saved = loadCriteria();
    if (!saved || !Array.isArray(saved.entries) || saved.entries.length === 0) return;
    applyCriteriaToDict(saved.entries);
    updateCriteriaUI(saved.name || 'ì‚¬ìš©ì ì •ì˜ ê¸°ì¤€');
  }

  /**
   * ë²”ë¡€ ë°°ì§€ + í‘¸í„° + ëª¨ë‹¬ ìƒíƒœ íŒ¨ë„ì„ ì—…ë°ì´íŠ¸.
   * nameì´ nullì´ë©´ "ê¸°ë³¸ JLPT ì‚¬ì „"ìœ¼ë¡œ ë¦¬ì…‹.
   */
  function updateCriteriaUI(name) {
    // ë²”ë¡€ ë°°ì§€
    const badge = document.getElementById('legendCriteriaBadge');
    if (badge) {
      if (name) {
        badge.textContent = 'ê¸°ì¤€: ' + name;
        badge.classList.add('visible');
      } else {
        badge.textContent = '';
        badge.classList.remove('visible');
      }
    }
    // í‘¸í„° íŒë³„ê¸°ì¤€
    const footerCriteria = document.getElementById('footerCriteriaName');
    if (footerCriteria) {
      footerCriteria.textContent = name || 'ë„¤ì´ë²„ ì¼ë³¸ì–´ ì‚¬ì „';
    }
    // ëª¨ë‹¬ ìƒíƒœ íŒ¨ë„ (ëª¨ë‹¬ì´ ì—´ë ¤ìˆì„ ë•Œë§Œ ì˜ë¯¸ ìˆì§€ë§Œ í•­ìƒ ë™ê¸°í™”)
    const dot  = document.getElementById('criteriaStatusDot');
    const text = document.getElementById('criteriaStatusText');
    if (dot && text) {
      if (name) {
        dot.className  = 'criteria-status-dot active';
        text.textContent = 'ì ìš© ì¤‘: ' + name;
      } else {
        dot.className  = 'criteria-status-dot inactive';
        text.textContent = 'í˜„ì¬ ì ìš©ëœ ê¸°ì¤€ ì—†ìŒ (ê¸°ë³¸ JLPT ì‚¬ì „ ì‚¬ìš©)';
      }
    }
    // íˆ´ë°” ë²„íŠ¼ ê°•ì¡° + ë ˆì´ë¸” ì—…ë°ì´íŠ¸
    const btn = document.getElementById('criteriaBtn');
    if (btn) {
      if (name) {
        btn.classList.add('criteria-active');
        btn.title = 'ì ìš© ì¤‘: ' + name + ' (í´ë¦­í•˜ì—¬ ë³€ê²½)';
        btn.innerHTML = 'âœ¦ ê¸°ì¤€';
      } else {
        btn.classList.remove('criteria-active');
        btn.title = 'ë ˆë²¨ ë¶„ë¥˜ ê¸°ì¤€ CSV ì—…ë¡œë“œ';
        btn.innerHTML = 'ğŸ“‹ ê¸°ì¤€';
      }
    }
  }

  // â”€â”€ ëª¨ë‹¬ ì—´ê¸° / ë‹«ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  let _criteriaParsed = null; // íŒŒì‹± ì™„ë£Œëœ entries ì„ì‹œ ë³´ê´€

  function openCriteriaModal() {
    _criteriaParsed = null;
    // íŒŒì‹± ì˜¤ë¥˜ ì´ˆê¸°í™”
    document.getElementById('criteriaParseError').textContent = '';
    // ì ìš© ë²„íŠ¼ ë¹„í™œì„±
    document.getElementById('criteriaApplyBtn').disabled = true;
    // ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¹€
    document.getElementById('criteriaPreviewWrap').style.display = 'none';

    // í˜„ì¬ ì €ì¥ëœ ê¸°ì¤€ ì´ë¦„ ë°˜ì˜
    const saved = loadCriteria();
    const nameInput = document.getElementById('criteriaNameInput');
    if (nameInput) nameInput.value = saved ? (saved.name || '') : '';

    // ìƒíƒœ íŒ¨ë„ ì—…ë°ì´íŠ¸
    updateCriteriaUI(saved ? saved.name : null);

    document.getElementById('criteriaModal').classList.add('visible');
    setTimeout(() => nameInput && nameInput.focus(), 60);
  }

  function closeCriteriaModal() {
    document.getElementById('criteriaModal').classList.remove('visible');
    _criteriaParsed = null;
  }

  // â”€â”€ CSV íŒŒì¼ ì²˜ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function handleCriteriaFileSelect(event) {
    const file = event.target.files && event.target.files[0];
    event.target.value = ''; // ê°™ì€ íŒŒì¼ ì¬ì„ íƒ í—ˆìš©
    if (!file) return;
    readCriteriaFile(file);
  }

  function handleCriteriaFileDrop(event) {
    const file = event.dataTransfer.files && event.dataTransfer.files[0];
    if (!file) return;
    readCriteriaFile(file);
  }

  function readCriteriaFile(file) {
    const reader = new FileReader();
    reader.onload = e => parseCriteriaCSV(e.target.result, file.name);
    reader.onerror = () => {
      document.getElementById('criteriaParseError').textContent = 'íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    };
    reader.readAsText(file, 'utf-8');
  }

  /**
   * CSV íŒŒì‹±: í—¤ë” í–‰ ìë™ ê°ì§€, ë¹ˆ ì¤„Â·ì£¼ì„(#) ìŠ¤í‚µ
   * í˜•ì‹: ì½ê¸°(íˆë¼ê°€ë‚˜), í•œì, ë¶„ë¥˜ê¸°ì¤€
   */
  function parseCriteriaCSV(text, filename) {
    const errEl = document.getElementById('criteriaParseError');
    errEl.textContent = '';
    _criteriaParsed = null;
    document.getElementById('criteriaApplyBtn').disabled = true;
    document.getElementById('criteriaPreviewWrap').style.display = 'none';

    const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
    const entries = [];
    let skipped = 0;

    for (let i = 0; i < lines.length; i++) {
      const raw = lines[i].trim();
      if (!raw || raw.startsWith('#')) continue;

      // ì‰¼í‘œ or íƒ­ êµ¬ë¶„ì ìë™ íŒë³„
      const sep = raw.includes('\t') ? '\t' : ',';
      const cols = raw.split(sep).map(c => c.trim().replace(/^["']|["']$/g, ''));

      if (cols.length < 3) { skipped++; continue; }

      const reading = cols[0];
      const surface = cols[1];
      const level   = cols[2].toUpperCase();

      // í—¤ë” í–‰ ê°ì§€ (readingì´ ìˆœìˆ˜ ASCII í‚¤ì›Œë“œì¸ ê²½ìš°)
      if (i === 0 && /^(reading|yomi|íˆë¼ê°€ë‚˜|ì½ê¸°)/i.test(reading)) continue;

      // ë ˆë²¨ ê°’ í—ˆìš©: N1~N5, å¤–, ì»¤ìŠ¤í…€ ë¬¸ìì—´(ìµœëŒ€ 10ì)
      if (!reading && !surface) { skipped++; continue; }

      entries.push({ reading, surface, level });
    }

    if (entries.length === 0) {
      errEl.textContent = `íŒŒì‹±ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. (ê±´ë„ˆëœ€: ${skipped}í–‰) â€” CSV í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`;
      return;
    }

    // íŒŒì‹± ì„±ê³µ
    _criteriaParsed = entries;

    // íŒŒì¼ëª…ì—ì„œ ê¸°ì¤€ ì´ë¦„ ìë™ ì œì•ˆ (í™•ì¥ì ì œê±°)
    const nameInput = document.getElementById('criteriaNameInput');
    if (nameInput && !nameInput.value.trim()) {
      nameInput.value = filename.replace(/\.[^.]+$/, '');
    }

    // ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§ (ìµœëŒ€ 10í–‰)
    renderCriteriaPreview(entries, skipped);

    document.getElementById('criteriaApplyBtn').disabled = false;
  }

  function renderCriteriaPreview(entries, skipped) {
    const wrap = document.getElementById('criteriaPreviewWrap');
    const body = document.getElementById('criteriaPreviewBody');
    const more = document.getElementById('criteriaPreviewMore');
    wrap.style.display = '';

    const preview = entries.slice(0, 10);
    body.innerHTML = preview.map(e => {
      const lv   = e.level;
      const color = LEVEL_COLOR[lv] || '#888';
      return `<tr>
        <td>${escHtml(e.reading)}</td>
        <td>${escHtml(e.surface)}</td>
        <td style="color:${color};font-weight:600;">${escHtml(lv)}</td>
      </tr>`;
    }).join('');

    const extra = entries.length - preview.length;
    if (extra > 0) {
      more.textContent = `+ ${extra}ê°œ í•­ëª© ë” ìˆìŒ (ì´ ${entries.length}ê°œ, ê±´ë„ˆëœ€ ${skipped}í–‰)`;
    } else {
      more.textContent = `ì´ ${entries.length}ê°œ í•­ëª©${skipped > 0 ? ` (ê±´ë„ˆëœ€ ${skipped}í–‰)` : ''}`;
    }
  }

  // â”€â”€ ì ìš© / ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function applyCriteriaParsed() {
    if (!_criteriaParsed || _criteriaParsed.length === 0) return;
    const nameInput = document.getElementById('criteriaNameInput');
    const name = (nameInput && nameInput.value.trim()) || 'ì‚¬ìš©ì ì •ì˜ ê¸°ì¤€';

    // localStorage ì €ì¥
    saveCriteria({ name, entries: _criteriaParsed });

    // JLPT_DICT ì¦‰ì‹œ ë°˜ì˜
    applyCriteriaToDict(_criteriaParsed);

    // UI ì—…ë°ì´íŠ¸ (ë²”ë¡€ ë°°ì§€, í‘¸í„°)
    updateCriteriaUI(name);
    touchDictUpdated();

    // í˜„ì¬ ë¶„ì„ ê²°ê³¼ ì¦‰ì‹œ ì¬ë¶„ì„
    if (lastResult) {
      const text = lastResult.input;
      document.getElementById('inputText').value = text;
      analyze();
    }

    closeCriteriaModal();
  }

  function clearCriteria() {
    if (!confirm('ë¶„ë¥˜ê¸°ì¤€ì„ ì´ˆê¸°í™”í•˜ë©´ ê¸°ë³¸ JLPT ì‚¬ì „ìœ¼ë¡œ ë˜ëŒì•„ê°‘ë‹ˆë‹¤. ì´ˆê¸°í™”í• ê¹Œìš”?')) return;

    // localStorage ì‚­ì œ
    localStorage.removeItem(CUSTOM_CRITERIA_KEY);

    // UI ë¦¬ì…‹
    updateCriteriaUI(null);

    closeCriteriaModal();

    // ê¸°ë³¸ ì‚¬ì „ ë³µì›ì„ ìœ„í•´ í˜ì´ì§€ ë¦¬ë¡œë“œ (ê°€ì¥ ì•ˆì „)
    location.reload();
  }

</script>


</body>
</html>
